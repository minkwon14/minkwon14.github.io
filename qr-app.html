<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>샤인 링크</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- QR code reader (for scanning) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root {
      color-scheme: light dark;
      /* Light mode – cozy holiday vibes */
      --bg: #0b1020;
      --fg: #111827;
      --card-bg: #fdf7ec;
      --accent: #b91c1c; /* deep red */
      --accent-soft: rgba(185, 28, 28, 0.18);
      --accent-green: #15803d;
      --accent-gold: #facc15;
      --border: #e5e7eb;
    }

    body.dark {
      /* Dark mode – richer navy + green, readable text */
      --bg: #020617;
      --fg: #e5e7eb;
      --card-bg: #020a18;
      --accent: #22c55e; /* green accent */
      --accent-soft: rgba(34, 197, 94, 0.22);
      --accent-green: #22c55e;
      --accent-gold: #facc15;
      --border: #1f2937;
    }

    @media (prefers-color-scheme: dark) {
      body:not(.light) {
        --bg: #020617;
        --fg: #e5e7eb;
        --card-bg: #020a18;
        --accent: #22c55e;
        --accent-soft: rgba(34, 197, 94, 0.22);
        --accent-green: #22c55e;
        --accent-gold: #facc15;
        --border: #1f2937;
      }
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, rgba(220, 38, 38, 0.22), transparent 55%),
        radial-gradient(circle at top right, rgba(22, 163, 74, 0.26), transparent 60%),
        radial-gradient(circle at bottom, rgba(250, 204, 21, 0.18), var(--bg) 70%);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    #app {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow:
        0 22px 50px rgba(15, 23, 42, 0.45),
        0 0 0 1px rgba(148, 163, 184, 0.15);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    /* subtle sparkle / ribbon overlay */
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        linear-gradient(135deg, rgba(250, 250, 250, 0.26), transparent 50%),
        radial-gradient(circle at top right, rgba(250, 204, 21, 0.28), transparent 60%),
        linear-gradient(
          60deg,
          transparent 0,
          transparent 40%,
          rgba(254, 202, 202, 0.35) 50%,
          transparent 60%,
          transparent 100%
        );
      mix-blend-mode: soft-light;
      opacity: 0.9;
    }

    .card > * { position: relative; }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    header h1 {
      font-size: 1.1rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    header h1 span.logo-dot {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fefce8, var(--accent-gold));
      box-shadow:
        0 0 0 4px rgba(250, 204, 21, 0.25),
        0 0 12px rgba(250, 204, 21, 0.6);
    }

    .pill {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.7);
      background: rgba(250, 250, 250, 0.7);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #92400e;
    }

    body.dark .pill {
      background: rgba(31, 41, 55, 0.95);
      color: #fef9c3;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent-gold);
      box-shadow: 0 0 6px rgba(250, 204, 21, 0.9);
    }

    .screen {
      display: none;
      flex-direction: column;
      gap: 12px;
    }

    .screen.active { display: flex; }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 0.8rem;
      font-weight: 500;
    }

    .field input {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.02);
      color: var(--fg);
      font-size: 0.9rem;
    }

    body.dark .field input {
      background: rgba(15, 23, 42, 0.8);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .field input:focus {
      outline: 2px solid var(--accent-soft);
      border-color: var(--accent);
    }

    .question-block {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      background:
        linear-gradient(
          135deg,
          rgba(22, 163, 74, 0.06),
          rgba(185, 28, 28, 0.04)
        );
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    body.dark .question-block {
      background:
        radial-gradient(circle at top, rgba(22, 163, 74, 0.28), transparent 65%),
        radial-gradient(circle at bottom, rgba(185, 28, 28, 0.2), transparent 65%);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .question-text {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 2px;
    }

    .option-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .option-item input {
      margin-top: 2px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.06s ease, box-shadow 0.06s ease, background 0.12s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #be123c);
      color: white;
      box-shadow: 0 10px 25px rgba(185, 28, 28, 0.55);
    }

    body.dark .btn-primary {
      background: linear-gradient(135deg, var(--accent-green), #16a34a);
      box-shadow: 0 10px 28px rgba(16, 185, 129, 0.65);
    }

    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 12px rgba(185, 28, 28, 0.6);
    }

    body.dark .btn-primary:active {
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.7);
    }

    .btn-outline {
      background: rgba(248, 250, 252, 0.8);
      border: 1px solid var(--border);
      color: var(--fg);
    }

    body.dark .btn-outline {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
    }

    .btn-outline:active {
      transform: translateY(1px) scale(0.99);
    }

    .footer-row {
      display: flex;
      gap: 8px;
      justify-content: space-between;
    }

    .footer-row .btn { flex: 1; }

    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }

    .qr-box {
      margin-top: 4px;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
      border-radius: 18px;
      border: 1px dashed rgba(250, 204, 21, 0.7);
      background:
        radial-gradient(circle at top, rgba(250, 204, 21, 0.25), transparent 60%),
        radial-gradient(circle at bottom, rgba(22, 163, 74, 0.22), transparent 60%);
      min-height: 260px;
    }

    body.dark .qr-box {
      background:
        radial-gradient(circle at top, rgba(250, 204, 21, 0.18), transparent 60%),
        radial-gradient(circle at bottom, rgba(34, 197, 94, 0.3), transparent 65%);
      border-color: rgba(250, 250, 250, 0.6);
    }

    .qr-box img {
      max-width: 360px;
      width: 85%;
      height: auto;
      margin: 0 auto;
      display: block;
    }

    .chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .chip {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(248, 250, 252, 0.9);
      border: 1px solid rgba(209, 213, 219, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    body.dark .chip {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .chip span.label { opacity: 0.7; }
    .chip strong { font-weight: 600; }

    .top-controls {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      align-items: center;
      font-size: 0.75rem;
    }

    .link-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .link-tile {
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: rgba(248, 250, 252, 0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      cursor: pointer;
    }

    body.dark .link-tile {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .link-tile-title {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .link-tile-sub {
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .scanned-count {
      font-size: 1.1rem;
      font-weight: 700;
    }

    #scanner-container {
      position: relative;
      overflow: hidden;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: black;
      height: min(60vh, 420px);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #scan-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #scan-overlay-inner {
      width: 80%;
      max-width: 300px;
      aspect-ratio: 1 / 1;
      border-radius: 22px;
      border: 2px solid rgba(248, 250, 252, 0.9);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.6), 0 18px 40px rgba(0, 0, 0, 0.6);
    }

    #scan-status {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    #scan-list {
      max-height: 60vh;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(248, 250, 252, 0.92);
    }

    body.dark #scan-list {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .scan-row {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .scan-row:last-child { border-bottom: none; }

    .scan-row-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-weight: 600;
    }

    .scan-row-meta {
      font-size: 0.7rem;
      opacity: 0.85;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* Full match: green */
    .match-badge-full {
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 2px 6px;
      background: rgba(22, 163, 74, 0.18);
      border: 1px solid rgba(22, 163, 74, 0.95);
      color: #166534;
      font-weight: 600;
    }

    body.dark .match-badge-full {
      background: rgba(34, 197, 94, 0.18);
      border-color: rgba(34, 197, 94, 0.95);
      color: #bbf7d0;
    }

    /* Partial match: gold/yellow */
    .match-badge-partial {
      font-size: 0.7rem;
      border-radius: 999px;
      padding: 2px 6px;
      background: rgba(250, 204, 21, 0.2);
      border: 1px solid rgba(250, 204, 21, 0.95);
      color: #92400e;
      font-weight: 500;
    }

    body.dark .match-badge-partial {
      background: rgba(250, 204, 21, 0.22);
      color: #fef9c3;
    }

    .empty-state {
      text-align: center;
      padding: 16px;
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .subtle {
      font-size: 0.75rem;
      opacity: 0.9;
    }

    .detail-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 0.85rem;
    }

    .detail-question {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .detail-answer-pill {
      display: inline-flex;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(248, 250, 252, 0.9);
      font-size: 0.8rem;
      margin-top: 2px;
    }

    body.dark .detail-answer-pill {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .detail-answer-same {
      background: linear-gradient(135deg, rgba(250, 204, 21, 0.22), rgba(22, 163, 74, 0.18));
      border-color: rgba(250, 204, 21, 0.95);
      color: #78350f;
      font-weight: 600;
    }

    body.dark .detail-answer-same {
      color: #fef3c7;
    }

    .detail-name {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .detail-mettime {
      font-size: 0.75rem;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="card">
      <header>
        <h1 id="app-title">
          <span class="logo-dot"></span>
        </h1>
        <div class="pill">
          <span class="pill-dot"></span>
          <span id="pill-status">준비 완료</span>
        </div>
      </header>

      <div class="top-controls">
        <button id="lang-toggle" class="btn btn-outline" type="button">한국어</button>
        <button id="theme-toggle" class="btn btn-outline" type="button">자동</button>
      </div>

      <!-- Screen 1: My profile & answers -->
      <section id="screen-1" class="screen active">
        <p class="subtle" id="intro-text">
          오늘 파티에서 나와 비슷한 사람을 찾아볼까요? 질문에 답하고 나만의 QR을 만들어 보세요.
        </p>

        <div class="field">
          <label for="fullName" id="label-fullname">이름</label>
          <input id="fullName" placeholder="예: 권민서" />
        </div>

        <div class="question-block" id="q1-block">
          <div class="question-text" id="q1-text">
            Q1. 지금 내 마음속 캐롤은?
          </div>
          <div class="options" id="q1-options"></div>
        </div>

        <div class="question-block" id="q2-block">
          <div class="question-text" id="q2-text">
            Q2. 오늘 내가 가장 기대하는 건?
          </div>
          <div class="options" id="q2-options"></div>
        </div>

        <div class="question-block" id="q3-block">
          <div class="question-text" id="q3-text">
            Q3. 오늘의 TMI는?
          </div>
          <div class="options" id="q3-options"></div>
        </div>

        <div class="question-block" id="q4-block">
          <div class="question-text" id="q4-text">
            Q4. 오늘 파티에서 나의 캐릭터는?
          </div>
          <div class="options" id="q4-options"></div>
        </div>

        <button id="save-profile" class="btn btn-primary" type="button">
          내 답변 저장하고 QR 보기
        </button>
      </section>

      <!-- Screen 2: My QR -->
      <section id="screen-2" class="screen">
        <div class="chip-list" id="profile-summary"></div>

        <div class="qr-box">
          <div id="qrcode"></div>
        </div>

        <div class="link-row">
          <div class="link-tile" id="open-met-list">
            <span class="link-tile-title" id="met-title">만난 사람</span>
            <span class="scanned-count" id="met-count">0</span>
            <span class="link-tile-sub" id="met-subtitle">지금까지 만난 사람 목록 보기</span>
          </div>

          <div style="width: 10px;"></div>

          <button id="open-scanner" class="btn btn-primary" type="button">
            QR 스캔하기
          </button>
        </div>

        <div class="meta-row">
          <span class="subtle" id="qr-description">
            QR에는 이름과 네 가지 질문에 대한 답이 담겨 있어요.
          </span>
          <button id="edit-profile" class="btn btn-outline" type="button">내 답변 수정</button>
        </div>
      </section>

      <!-- Screen 3: Scanner -->
      <section id="screen-3" class="screen">
        <div id="scanner-container">
          <video id="video" playsinline></video>
          <canvas id="scan-canvas" style="display:none;"></canvas>
          <div id="scan-overlay">
            <div id="scan-overlay-inner"></div>
          </div>
        </div>

        <div class="meta-row">
          <span id="scan-status">QR를 가운데 네모 안에 맞추고, 너무 가까이 말고 살짝 떨어져 보세요.</span>
          <div style="display:flex;gap:6px;">
            <button id="flip-camera" class="btn btn-outline" type="button">
              카메라 전환
            </button>
            <button id="stop-scan" class="btn btn-outline" type="button">
              완료
            </button>
          </div>
        </div>
      </section>

      <!-- Screen 4: Met list -->
      <section id="screen-4" class="screen">
        <div class="meta-row">
          <span class="subtle" id="met-list-title">지금까지 만난 사람</span>
          <button id="back-to-main" class="btn btn-outline" type="button">
            뒤로
          </button>
        </div>

        <div id="scan-list"></div>

        <div class="footer-row">
          <button id="clear-met" class="btn btn-outline" type="button">전체 삭제</button>
          <button id="back-to-qr" class="btn btn-primary" type="button">내 QR 보기</button>
        </div>
      </section>

      <!-- Screen 5: Person detail -->
      <section id="screen-5" class="screen">
        <div class="meta-row">
          <span class="subtle" id="detail-title">상세 정보</span>
          <button id="back-from-detail" class="btn btn-outline" type="button">
            뒤로
          </button>
        </div>

        <div class="detail-name" id="detail-name"></div>
        <div class="detail-mettime" id="detail-mettime"></div>

        <div class="detail-list" id="detail-qa"></div>
      </section>
    </div>

    <p class="subtle" id="footer-text" style="text-align:center;margin-top:4px;">
      데이터는 이 브라우저 안에만 저장됩니다 (쿠키 사용).
    </p>
  </div>

  <script>
    // ---------- Question model ----------
    const QUESTIONS = {
      ko: [
        {
          id: "q1",
          text: "Q1. 지금 내 마음속 캐롤은?",
          options: [
            "징글벨—하이텐션 모드",
            "고요한 밤—평온 모드",
            "루돌프—약간 들떠있음"
          ]
        },
        {
          id: "q2",
          text: "Q2. 오늘 내가 가장 기대하는 건?",
          options: [
            "음식! 음식! 그리고 음식!",
          "사람들과의 수다",
            "예상 못한 웃긴 이벤트"
          ]
        },
        {
          id: "q3",
          text: "Q3. 오늘의 TMI는?",
          options: [
            "사실 오늘 패션은 5분 컷이다",
            "올 때부터 배고팠다",
            "왜인지 설렌다"
          ]
        },
        {
          id: "q4",
          text: "Q4. 오늘 파티에서 나의 캐릭터는?",
          options: [
            "먼저 다가가 반갑게 인사하는 ‘샬롬 전도사’",
            "조용히 주변을 따뜻하게 지켜보는 ‘평안 수호자’",
            "오늘 파티를 사진으로 남기려는 ‘추억 기록자’"
          ]
        }
      ],
      en: [
        {
          id: "q1",
          text: "Q1. What’s your inner carol right now?",
          options: [
            "Jingle Bells – high-tension mode",
            "Silent Night – peaceful mode",
            "Rudolph – a bit excited"
          ]
        },
        {
          id: "q2",
          text: "Q2. What are you most excited about today?",
          options: [
            "Food! Food! And more food!",
            "Chatting with people",
            "Unexpected funny moments"
          ]
        },
        {
          id: "q3",
          text: "Q3. Today’s TMI is…",
          options: [
            "My outfit took exactly 5 minutes",
            "I was hungry on the way here",
            "I feel weirdly fluttery"
          ]
        },
        {
          id: "q4",
          text: "Q4. My party character today is…",
          options: [
            "The one who greets first – ‘Shalom Ambassador’",
            "Quietly guarding the peace – ‘Guardian of Calm’",
            "Capturing everything – ‘Memory Keeper’"
          ]
        }
      ]
    };

    function getQuestions() {
      return QUESTIONS[currentLang];
    }

    // Helper: extract a short title from Q4 option string
    function getQ4ShortTitle(optionText) {
      if (!optionText) return "";
      // Try Korean quotes ‘ ’ or " "
      const quoteMatch = optionText.match(/[‘'"](.*?)[’'"]/);
      if (quoteMatch && quoteMatch[1]) {
        return quoteMatch[1].trim();
      }
      // Fallback: last word
      const parts = optionText.split(/[\s]/).filter(Boolean);
      return parts.length ? parts[parts.length - 1] : optionText;
    }

    // ---------- Strings ----------
    const STRINGS = {
      ko: {
        appTitle: "샤인 링크",
        pillReady: "준비 완료",
        pillSaved: "프로필이 저장되었습니다",
        pillLoaded: "쿠키에서 불러왔습니다",
        pillSetup: "이름과 질문에 먼저 답해 주세요",

        langButton: "한국어",
        themeAuto: "자동",
        themeDark: "다크",
        themeLight: "라이트",

        intro: "오늘 파티에서 나와 비슷한 사람을 찾아볼까요? 질문에 답하고 나만의 QR을 만들어 보세요.",
        fullNameLabel: "이름",
        fullNamePlaceholder: "예: 권민서",
        saveProfile: "내 답변 저장하고 QR 보기",
        editProfile: "내 답변 수정",

        metTitle: "만난 사람",
        metSubtitle: "지금까지 만난 사람 목록 보기",
        qrDescription: "QR에는 이름과 네 가지 질문에 대한 답이 담겨 있어요.",
        scanButton: "QR 스캔하기",

        scanStatusIntro: "QR를 가운데 네모 안에 맞추고, 너무 가까이 말고 살짝 떨어져 보세요.",
        scanStatusTrying: "QR를 읽는 중입니다… 화면과 거리를 조금만 조절해 주세요.",
        scanStatusStopped: "스캐너가 종료되었습니다.",
        scanStatusFormatUnsupported: "QR은 인식했지만 이 앱에서 사용하는 형식이 아닙니다.",
        scanStatusMissingName: "QR은 인식했지만 이름이 없습니다.",

        flipCamera: "카메라 전환",
        doneScan: "완료",

        metListTitle: "지금까지 만난 사람",
        clearMet: "전체 삭제",
        back: "뒤로",
        backToQR: "내 QR 보기",

        emptyState: "아직 아무도 없어요. 누군가를 만나서 QR를 스캔해 보세요!",
        footer: "데이터는 이 브라우저 안에만 저장됩니다 (쿠키 사용).",

        detailTitle: "상세 정보",
        matchBadge: "나와 네 문제 모두 같아요!",
        matchPartial: "같은 답이 있는 친구예요!",

        alertEnterRequired: "이름과 모든 질문에 답해 주세요.",
        alertClearConfirm: "정말로 만난 사람 목록을 모두 삭제할까요?",
        alertScanned: name => `스캔 완료: ${name} 님 정보를 저장했습니다.`,
        alertCameraUnsupported: "이 브라우저에서는 카메라를 사용할 수 없습니다.",
        alertCameraError: msg => `카메라에 접근할 수 없습니다: ${msg}`
      },
      en: {
        appTitle: "Shine Link",
        pillReady: "Ready",
        pillSaved: "Profile saved",
        pillLoaded: "Loaded from cookie",
        pillSetup: "Please enter your name and answer the questions first.",

        langButton: "English",
        themeAuto: "Auto",
        themeDark: "Dark",
        themeLight: "Light",

        intro: "Want to find people like you at the party? Answer a few questions and create your own QR.",
        fullNameLabel: "Name",
        fullNamePlaceholder: "e.g. Minseo Kwon",
        saveProfile: "Save my answers & show QR",
        editProfile: "Edit my answers",

        metTitle: "People I’ve met",
        metSubtitle: "See everyone you’ve met so far",
        qrDescription: "Your QR includes your name and answers to four questions.",
        scanButton: "Scan QR",

        scanStatusIntro: "Align the QR inside the square, not too close, and hold still…",
        scanStatusTrying: "Trying to read the QR… adjust distance slightly and hold still.",
        scanStatusStopped: "Scanner stopped.",
        scanStatusFormatUnsupported: "QR detected, but format is not supported.",
        scanStatusMissingName: "QR detected, but name is missing.",

        flipCamera: "Flip camera",
        doneScan: "Done",

        metListTitle: "People you’ve met",
        clearMet: "Clear list",
        back: "Back",
        backToQR: "My QR",

        emptyState: "No one yet. Go meet someone and scan their QR!",
        footer: "Data stays in this browser only (stored in cookies).",

        detailTitle: "Details",
        matchBadge: "All 4 answers match you!",
        matchPartial: "You share some answers!",

        alertEnterRequired: "Please fill in your name and answer all questions.",
        alertClearConfirm: "Clear everyone in your met list?",
        alertScanned: name => `Scanned and saved: ${name}`,
        alertCameraUnsupported: "Camera access is not supported in this browser.",
        alertCameraError: msg => `Unable to access camera: ${msg}`
      }
    };

    // ---------- Cookies ----------
    function setCookie(name, value, days) {
      const d = new Date();
      d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
      document.cookie = name + "=" + encodeURIComponent(value) +
        ";expires=" + d.toUTCString() + ";path=/";
    }

    function getCookie(name) {
      const cname = name + "=";
      const decoded = decodeURIComponent(document.cookie);
      const parts = decoded.split(";");
      for (let c of parts) {
        c = c.trim();
        if (c.indexOf(cname) === 0) {
          return c.substring(cname.length);
        }
      }
      return "";
    }

    // ---------- State ----------
    const profileCookieKey = "shine_profile_v2";
    const metCookieKey = "shine_met_list_v2";
    const themeCookieKey = "shine_theme";
    const langCookieKey = "shine_lang";

    // profile: { name, a1, a2, a3, a4 }
    let profile = null;
    // metList: { name, a1, a2, a3, a4, timestamp }
    let metList = [];
    let themeMode = "auto";
    let currentLang = "ko";

    let videoStream = null;
    let usingRear = true;
    let scanLoopId = null;
    let lastScannedValue = null;
    let lastDecodeTime = 0;

    function t(key, ...args) {
      const s = STRINGS[currentLang][key];
      return typeof s === "function" ? s(...args) : (s ?? "");
    }

    // ---------- DOM refs ----------
    const screens = {
      s1: document.getElementById("screen-1"),
      s2: document.getElementById("screen-2"),
      s3: document.getElementById("screen-3"),
      s4: document.getElementById("screen-4"),
      s5: document.getElementById("screen-5"),
    };

    const appTitleEl = document.getElementById("app-title");
    const pillStatus = document.getElementById("pill-status");
    const langToggleBtn = document.getElementById("lang-toggle");
    const themeToggleBtn = document.getElementById("theme-toggle");
    const introText = document.getElementById("intro-text");

    const fullNameLabel = document.getElementById("label-fullname");
    const fullNameInput = document.getElementById("fullName");
    const saveProfileBtn = document.getElementById("save-profile");
    const editProfileBtn = document.getElementById("edit-profile");

    const q1Options = document.getElementById("q1-options");
    const q2Options = document.getElementById("q2-options");
    const q3Options = document.getElementById("q3-options");
    const q4Options = document.getElementById("q4-options");
    const q1Text = document.getElementById("q1-text");
    const q2Text = document.getElementById("q2-text");
    const q3Text = document.getElementById("q3-text");
    const q4Text = document.getElementById("q4-text");

    const profileSummary = document.getElementById("profile-summary");
    const metTitleEl = document.getElementById("met-title");
    const metSubtitleEl = document.getElementById("met-subtitle");
    const qrDescriptionEl = document.getElementById("qr-description");
    const metCount = document.getElementById("met-count");
    const scanListEl = document.getElementById("scan-list");

    const scanStatus = document.getElementById("scan-status");
    const flipCameraBtn = document.getElementById("flip-camera");
    const stopScanBtn = document.getElementById("stop-scan");
    const openScannerBtn = document.getElementById("open-scanner");

    const metListTitleDom = document.getElementById("met-list-title");
    const clearMetBtn = document.getElementById("clear-met");
    const backToMainBtn = document.getElementById("back-to-main");
    const backToQrBtn = document.getElementById("back-to-qr");
    const footerTextEl = document.getElementById("footer-text");

    const detailTitleEl = document.getElementById("detail-title");
    const backFromDetailBtn = document.getElementById("back-from-detail");
    const detailNameEl = document.getElementById("detail-name");
    const detailMetTimeEl = document.getElementById("detail-mettime");
    const detailQaEl = document.getElementById("detail-qa");

    const videoEl = document.getElementById("video");
    const scanCanvas = document.getElementById("scan-canvas");

    function showScreen(name) {
      Object.values(screens).forEach(el => el.classList.remove("active"));
      if (screens[name]) screens[name].classList.add("active");
    }

    function applyTheme() {
      document.body.classList.remove("dark", "light");
      if (themeMode === "dark") document.body.classList.add("dark");
      else if (themeMode === "light") document.body.classList.add("light");
      themeToggleBtn.textContent =
        themeMode === "auto" ? t("themeAuto") :
        themeMode === "dark" ? t("themeDark") :
        t("themeLight");
    }

    function renderQuestions() {
      const qs = getQuestions();

      q1Text.textContent = qs[0].text;
      q2Text.textContent = qs[1].text;
      q3Text.textContent = qs[2].text;
      q4Text.textContent = qs[3].text;

      function renderOptions(container, qId, options) {
        container.innerHTML = "";
        options.forEach((opt, idx) => {
          const label = document.createElement("label");
          label.className = "option-item";

          const input = document.createElement("input");
          input.type = "radio";
          input.name = qId;
          input.value = String(idx);

          const span = document.createElement("span");
          span.textContent = `${idx + 1}. ${opt}`;

          label.appendChild(input);
          label.appendChild(span);
          container.appendChild(label);
        });
      }

      renderOptions(q1Options, "q1", qs[0].options);
      renderOptions(q2Options, "q2", qs[1].options);
      renderOptions(q3Options, "q3", qs[2].options);
      renderOptions(q4Options, "q4", qs[3].options);

      // restore selected values if profile already set
      if (profile) {
        const { a1, a2, a3, a4 } = profile;
        if (a1 != null) {
          const el = document.querySelector(`input[name="q1"][value="${a1}"]`);
          if (el) el.checked = true;
        }
        if (a2 != null) {
          const el = document.querySelector(`input[name="q2"][value="${a2}"]`);
          if (el) el.checked = true;
        }
        if (a3 != null) {
          const el = document.querySelector(`input[name="q3"][value="${a3}"]`);
          if (el) el.checked = true;
        }
        if (a4 != null) {
          const el = document.querySelector(`input[name="q4"][value="${a4}"]`);
          if (el) el.checked = true;
        }
      }
    }

    function applyLanguage() {
      document.documentElement.lang = currentLang === "ko" ? "ko" : "en";
      document.title = t("appTitle");

      appTitleEl.innerHTML = `<span class="logo-dot"></span>${t("appTitle")}`;
      langToggleBtn.textContent = t("langButton");

      introText.textContent = t("intro");
      fullNameLabel.textContent = t("fullNameLabel");
      fullNameInput.placeholder = t("fullNamePlaceholder");

      saveProfileBtn.textContent = t("saveProfile");
      editProfileBtn.textContent = t("editProfile");

      metTitleEl.textContent = t("metTitle");
      metSubtitleEl.textContent = t("metSubtitle");
      qrDescriptionEl.textContent = t("qrDescription");
      openScannerBtn.textContent = t("scanButton");

      flipCameraBtn.textContent = t("flipCamera");
      stopScanBtn.textContent = t("doneScan");
      scanStatus.textContent = t("scanStatusIntro");

      footerTextEl.textContent = t("footer");
      detailTitleEl.textContent = t("detailTitle");

      applyTheme();
      renderQuestions();
      renderMetList(); // updates title with count
    }

    function toggleLanguage() {
      currentLang = currentLang === "ko" ? "en" : "ko";
      setCookie(langCookieKey, currentLang, 365);
      applyLanguage();
      updateProfileSummary();
    }

    function toggleTheme() {
      if (themeMode === "auto") themeMode = "dark";
      else if (themeMode === "dark") themeMode = "light";
      else themeMode = "auto";
      setCookie(themeCookieKey, themeMode, 365);
      applyTheme();
    }

    // ---------- QR encoding ----------
    // Format: name|a1|a2|a3|a4  (each answer index 0-2)
    function safeField(str) {
      if (!str) return "";
      return String(str).replace(/\|/g, "¦").slice(0, 80);
    }

    function encodeProfileForQR(p) {
      const name = safeField(p.name);
      const a1 = p.a1 ?? 0;
      const a2 = p.a2 ?? 0;
      const a3 = p.a3 ?? 0;
      const a4 = p.a4 ?? 0;
      return `${name}|${a1}|${a2}|${a3}|${a4}`;
    }

    function decodeProfileFromQR(str) {
      const parts = str.split("|");
      if (parts.length < 5) throw new Error("invalid format");
      const name = (parts[0] || "").trim();
      const a1 = parseInt(parts[1] || "0", 10);
      const a2 = parseInt(parts[2] || "0", 10);
      const a3 = parseInt(parts[3] || "0", 10);
      const a4 = parseInt(parts[4] || "0", 10);
      return { name, a1, a2, a3, a4 };
    }

    function updateQR() {
      if (!profile) return;

      const qrContainer = document.getElementById("qrcode");
      if (!qrContainer) return;

      profile = {
        name: profile.name || "",
        a1: profile.a1 ?? 0,
        a2: profile.a2 ?? 0,
        a3: profile.a3 ?? 0,
        a4: profile.a4 ?? 0
      };
      setCookie(profileCookieKey, JSON.stringify(profile), 365);

      const data = encodeProfileForQR(profile);

      qrContainer.innerHTML = "";

      const img = document.createElement("img");
      img.alt = "QR Code";
      img.src = "https://api.qrserver.com/v1/create-qr-code/?" +
        "size=360x360&data=" + encodeURIComponent(data) +
        "&ecc=M"; // medium error correction

      qrContainer.appendChild(img);
    }

    // ---------- UI helpers ----------
    function updateProfileSummary() {
      profileSummary.innerHTML = "";
      if (!profile) return;

      const qs = getQuestions();

      // Chip 1: 이름 권민서
      const chipName = document.createElement("div");
      chipName.className = "chip";
      const strongName = document.createElement("strong");
      strongName.textContent = profile.name;
      chipName.appendChild(strongName);
      profileSummary.appendChild(chipName);

      // Chip 2: only title from Q4, e.g. "샬롬 전도사"
      const q4Full = qs[3].options[profile.a4 ?? 0];
      const shortTitle = getQ4ShortTitle(q4Full);
      const chipChar = document.createElement("div");
      chipChar.className = "chip";
      const strongChar = document.createElement("strong");
      strongChar.textContent = shortTitle;
      chipChar.appendChild(strongChar);
      profileSummary.appendChild(chipChar);
    }

    function updateMetCount() {
      metCount.textContent = String(metList.length);
    }

    function answersAllSame(a, b) {
      if (!a || !b) return false;
      return a.a1 === b.a1 && a.a2 === b.a2 && a.a3 === b.a3 && a.a4 === b.a4;
    }

    function answersShareAny(a, b) {
      if (!a || !b) return false;
      return (
        a.a1 === b.a1 ||
        a.a2 === b.a2 ||
        a.a3 === b.a3 ||
        a.a4 === b.a4
      );
    }

    function updateMetListTitle() {
      const base = t("metListTitle");
      if (currentLang === "ko") {
        metListTitleDom.textContent = `${base} (${metList.length}명)`;
      } else {
        metListTitleDom.textContent = `${base} (${metList.length})`;
      }
    }

    function renderMetList() {
      scanListEl.innerHTML = "";
      updateMetListTitle();

      if (!metList.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = t("emptyState");
        scanListEl.appendChild(empty);
        return;
      }

      const qs = getQuestions();

      const sorted = metList
        .map((item, idx) => ({ item, idx }))
        .sort((a, b) => b.item.timestamp - a.item.timestamp);

      sorted.forEach(({ item, idx }) => {
        const row = document.createElement("div");
        row.className = "scan-row";
        row.dataset.index = String(idx);

        const header = document.createElement("div");
        header.className = "scan-row-header";
        const nameEl = document.createElement("div");
        nameEl.textContent = item.name || (currentLang === "ko" ? "이름 없음" : "Unknown");

        const timeEl = document.createElement("div");
        const dt = new Date(item.timestamp);
        timeEl.textContent = dt.toLocaleString();
        timeEl.style.fontSize = "0.75rem";
        timeEl.style.opacity = "0.8";

        header.appendChild(nameEl);
        header.appendChild(timeEl);

        const meta = document.createElement("div");
        meta.className = "scan-row-meta";

        // Q4 character (full text is okay here)
        const q4Span = document.createElement("span");
        q4Span.textContent = qs[3].options[item.a4 ?? 0] || "";
        meta.appendChild(q4Span);

        if (profile) {
          if (answersAllSame(profile, item)) {
            const badge = document.createElement("span");
            badge.className = "match-badge-full";
            badge.textContent = t("matchBadge");
            meta.appendChild(badge);
          } else if (answersShareAny(profile, item)) {
            const badge = document.createElement("span");
            badge.className = "match-badge-partial";
            badge.textContent = t("matchPartial");
            meta.appendChild(badge);
          }
        }

        row.appendChild(header);
        row.appendChild(meta);
        scanListEl.appendChild(row);
      });
    }

    function saveProfileFromInputs() {
      const name = fullNameInput.value.trim();
      const a1El = document.querySelector('input[name="q1"]:checked');
      const a2El = document.querySelector('input[name="q2"]:checked');
      const a3El = document.querySelector('input[name="q3"]:checked');
      const a4El = document.querySelector('input[name="q4"]:checked');

      if (!name || !a1El || !a2El || !a3El || !a4El) {
        alert(t("alertEnterRequired"));
        return false;
      }

      profile = {
        name,
        a1: parseInt(a1El.value, 10),
        a2: parseInt(a2El.value, 10),
        a3: parseInt(a3El.value, 10),
        a4: parseInt(a4El.value, 10)
      };
      setCookie(profileCookieKey, JSON.stringify(profile), 365);
      return true;
    }

    function saveMetList() {
      setCookie(metCookieKey, JSON.stringify(metList), 365);
    }

    // ---------- Detail view helper ----------
    function showPersonDetail(person) {
      const qs = getQuestions();
      const my = profile;

      detailNameEl.textContent = person.name || "";
      detailMetTimeEl.textContent = person.timestamp
        ? new Date(person.timestamp).toLocaleString()
        : "";

      detailQaEl.innerHTML = "";

      [
        { q: qs[0], key: "a1", idx: person.a1 },
        { q: qs[1], key: "a2", idx: person.a2 },
        { q: qs[2], key: "a3", idx: person.a3 },
        { q: qs[3], key: "a4", idx: person.a4 }
      ].forEach(entry => {
        const wrap = document.createElement("div");
        const qDiv = document.createElement("div");
        qDiv.className = "detail-question";
        qDiv.textContent = entry.q.text;

        const ansDiv = document.createElement("div");
        ansDiv.className = "detail-answer-pill";
        if (my && my[entry.key] === entry.idx) {
          ansDiv.classList.add("detail-answer-same");
        }
        const text = entry.q.options[entry.idx ?? 0] || "";
        ansDiv.textContent = text;

        wrap.appendChild(qDiv);
        wrap.appendChild(ansDiv);
        detailQaEl.appendChild(wrap);
      });

      showScreen("s5");
    }

    // ---------- Scanner ----------
    async function startScanner() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert(t("alertCameraUnsupported"));
        return;
      }
      try {
        pillStatus.textContent = t("pillReady");
        lastScannedValue = null;
        scanStatus.textContent = t("scanStatusIntro");

        const constraints = {
          video: {
            facingMode: usingRear ? { ideal: "environment" } : "user",
            width: { ideal: 640 },
            height: { ideal: 480 }
          },
          audio: false
        };
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        videoEl.srcObject = videoStream;

        await new Promise(resolve => {
          if (videoEl.readyState >= 2) resolve();
          else videoEl.onloadedmetadata = () => resolve();
        });

        await videoEl.play();
        showScreen("s3");
        startScanLoop();
      } catch (err) {
        console.error(err);
        alert(t("alertCameraError", err.message));
        pillStatus.textContent = t("pillReady");
      }
    }

    function stopScannerAndStayOnScreen2() {
      if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
      }
      if (scanLoopId) {
        cancelAnimationFrame(scanLoopId);
        scanLoopId = null;
      }
      videoEl.srcObject = null;
      scanStatus.textContent = t("scanStatusStopped");
      pillStatus.textContent = t("pillReady");
      showScreen("s2");
    }

    function stopScannerWithoutNavigation() {
      if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
      }
      if (scanLoopId) {
        cancelAnimationFrame(scanLoopId);
        scanLoopId = null;
      }
      videoEl.srcObject = null;
      pillStatus.textContent = t("pillReady");
    }

    function startScanLoop() {
      const ctx = scanCanvas.getContext("2d");

      const loop = () => {
        if (!videoStream) return;

        const now = performance.now();
        if (now - lastDecodeTime < 250) {
          scanLoopId = requestAnimationFrame(loop);
          return;
        }
        lastDecodeTime = now;

        if (videoEl.readyState === videoEl.HAVE_ENOUGH_DATA) {
          const vw = videoEl.videoWidth;
          const vh = videoEl.videoHeight;
          if (vw && vh) {
            scanCanvas.width = vw;
            scanCanvas.height = vh;
            ctx.drawImage(videoEl, 0, 0, vw, vh);

            const size = Math.floor(Math.min(vw, vh) * 0.7);
            const x = Math.floor((vw - size) / 2);
            const y = Math.floor((vh - size) / 2);
            const imageData = ctx.getImageData(x, y, size, size);

            const code = jsQR(imageData.data, imageData.width, imageData.height, {
              inversionAttempts: "dontInvert"
            });

            if (code && code.data) {
              if (code.data !== lastScannedValue) {
                lastScannedValue = code.data;
                handleScannedData(code.data);
              }
            } else {
              scanStatus.textContent = t("scanStatusTrying");
            }
          }
        }
        scanLoopId = requestAnimationFrame(loop);
      };
      loop();
    }

    function handleScannedData(dataStr) {
      let decoded;
      try {
        decoded = decodeProfileFromQR(dataStr);
      } catch (e) {
        console.error("Failed to decode profile from QR:", e);
        scanStatus.textContent = t("scanStatusFormatUnsupported");
        return;
      }

      const name = (decoded.name || "").trim();
      if (!name) {
        scanStatus.textContent = t("scanStatusMissingName");
        return;
      }

      const a1 = decoded.a1 ?? 0;
      const a2 = decoded.a2 ?? 0;
      const a3 = decoded.a3 ?? 0;
      const a4 = decoded.a4 ?? 0;

      let existing = metList.find(
        m =>
          m.name === name &&
          m.a1 === a1 &&
          m.a2 === a2 &&
          m.a3 === a3 &&
          m.a4 === a4
      );

      if (!existing) {
        existing = {
          name,
          a1,
          a2,
          a3,
          a4,
          timestamp: Date.now()
        };
        metList.push(existing);
        saveMetList();
        updateMetCount();
        renderMetList();
      }

      // Stop scanner and go directly to detail screen
      stopScannerWithoutNavigation();
      showPersonDetail(existing);
    }

    // ---------- Events & init ----------
    function wireEvents() {
      langToggleBtn.addEventListener("click", toggleLanguage);
      themeToggleBtn.addEventListener("click", toggleTheme);

      saveProfileBtn.addEventListener("click", () => {
        if (!saveProfileFromInputs()) return;
        pillStatus.textContent = t("pillSaved");
        updateProfileSummary();
        showScreen("s2");
        updateQR();
      });

      editProfileBtn.addEventListener("click", () => {
        if (profile) {
          fullNameInput.value = profile.name || "";
        }
        showScreen("s1");
      });

      clearMetBtn.addEventListener("click", () => {
        if (!metList.length) return;
        if (!confirm(t("alertClearConfirm"))) return;
        metList = [];
        saveMetList();
        updateMetCount();
        renderMetList();
      });

      document.getElementById("open-met-list").addEventListener("click", () => {
        renderMetList();
        showScreen("s4");
      });

      backToMainBtn.addEventListener("click", () => showScreen("s2"));
      backToQrBtn.addEventListener("click", () => showScreen("s2"));
      backFromDetailBtn.addEventListener("click", () => showScreen("s4"));

      openScannerBtn.addEventListener("click", startScanner);
      stopScanBtn.addEventListener("click", stopScannerAndStayOnScreen2);
      flipCameraBtn.addEventListener("click", async () => {
        usingRear = !usingRear;
        stopScannerWithoutNavigation();
        await startScanner();
      });

      scanListEl.addEventListener("click", e => {
        const row = e.target.closest(".scan-row");
        if (!row) return;
        const idx = parseInt(row.dataset.index, 10);
        const person = metList[idx];
        if (!person) return;
        showPersonDetail(person);
      });
    }

    function loadCookies() {
      const storedLang = getCookie(langCookieKey);
      if (storedLang === "ko" || storedLang === "en") currentLang = storedLang;

      const storedTheme = getCookie(themeCookieKey);
      if (storedTheme === "auto" || storedTheme === "dark" || storedTheme === "light") {
        themeMode = storedTheme;
      }

      const storedProfile = getCookie(profileCookieKey);
      if (storedProfile) {
        try {
          const p = JSON.parse(storedProfile);
          if (p && typeof p.name === "string") {
            profile = {
              name: p.name || "",
              a1: p.a1 ?? 0,
              a2: p.a2 ?? 0,
              a3: p.a3 ?? 0,
              a4: p.a4 ?? 0
            };
          }
        } catch {
          profile = null;
        }
      }

      const storedMet = getCookie(metCookieKey);
      if (storedMet) {
        try { metList = JSON.parse(storedMet) || []; } catch { metList = []; }
      }
    }

    function initUI() {
      loadCookies();
      applyLanguage();
      wireEvents();

      if (profile) {
        fullNameInput.value = profile.name || "";

        renderQuestions();
        if (profile.a1 != null) {
          const el = document.querySelector(`input[name="q1"][value="${profile.a1}"]`);
          if (el) el.checked = true;
        }
        if (profile.a2 != null) {
          const el = document.querySelector(`input[name="q2"][value="${profile.a2}"]`);
          if (el) el.checked = true;
        }
        if (profile.a3 != null) {
          const el = document.querySelector(`input[name="q3"][value="${profile.a3}"]`);
          if (el) el.checked = true;
        }
        if (profile.a4 != null) {
          const el = document.querySelector(`input[name="q4"][value="${profile.a4}"]`);
          if (el) el.checked = true;
        }

        updateProfileSummary();
        updateQR();
        showScreen("s2");
        pillStatus.textContent = t("pillLoaded");
      } else {
        showScreen("s1");
        pillStatus.textContent = t("pillSetup");
      }
      updateMetCount();
      renderMetList();
    }

    window.addEventListener("load", initUI);
  </script>
</body>
</html>
