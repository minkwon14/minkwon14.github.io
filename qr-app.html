<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>밋 트래커</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- QR code reader -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <!-- LOCAL QR code generator (must be in same folder) -->
  <script src="qrcode.min.js"></script>
  <!-- Compression library for shorter QR payloads -->
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>

  <style>
    :root {
      color-scheme: light dark;
      --bg: #f3f4f6;
      --fg: #111827;
      --card-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: rgba(37, 99, 235, 0.1);
      --border: #e5e7eb;
    }

    body.dark {
      --bg: #020617;
      --fg: #e5e7eb;
      --card-bg: #020617;
      --accent: #60a5fa;
      --accent-soft: rgba(96, 165, 250, 0.15);
      --border: #1f2937;
    }

    @media (prefers-color-scheme: dark) {
      body:not(.light) {
        --bg: #020617;
        --fg: #e5e7eb;
        --card-bg: #020617;
        --accent: #60a5fa;
        --accent-soft: rgba(96, 165, 250, 0.15);
        --border: #1f2937;
      }
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e5e7eb 0, var(--bg) 40%);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    #app {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    header h1 {
      font-size: 1.1rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    header h1 span.logo-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-soft);
    }

    .pill {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--accent-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .screen {
      display: none;
      flex-direction: column;
      gap: 12px;
    }

    .screen.active { display: flex; }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 0.8rem;
      font-weight: 500;
    }

    .field input,
    .field select {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.02);
      color: var(--fg);
      font-size: 0.9rem;
    }

    .field input:focus,
    .field select:focus {
      outline: 2px solid var(--accent-soft);
      border-color: var(--accent);
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.06s ease, box-shadow 0.06s ease, background 0.12s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #9333ea);
      color: white;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
    }

    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.45);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--fg);
    }

    .btn-outline:active {
      transform: translateY(1px) scale(0.99);
    }

    .footer-row {
      display: flex;
      gap: 8px;
      justify-content: space-between;
    }

    .footer-row .btn { flex: 1; }

    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }

    .qr-box {
      margin-top: 4px;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
      border-radius: 18px;
      border: 1px dashed var(--border);
      background: radial-gradient(circle at top, var(--accent-soft), transparent);
      min-height: 220px;
    }

    .qr-box canvas,
    .qr-box img {
      max-width: 300px;
      width: 80%;
      height: auto;
      margin: 0 auto;
      display: block;
    }

    .chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .chip {
      font-size: 0.75rem;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.04);
      border: 1px solid var(--border);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chip span.label { opacity: 0.7; }

    .chip strong { font-weight: 600; }

    .top-controls {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      align-items: center;
      font-size: 0.75rem;
    }

    .link-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .link-tile {
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.02);
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      cursor: pointer;
    }

    .link-tile-title {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .link-tile-sub {
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .scanned-count {
      font-size: 1.1rem;
      font-weight: 700;
    }

    #scanner-container {
      position: relative;
      overflow: hidden;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: black;
      height: min(60vh, 420px);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #scan-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #scan-overlay-inner {
      width: 80%;
      max-width: 300px;
      aspect-ratio: 1 / 1;
      border-radius: 22px;
      border: 2px solid rgba(248, 250, 252, 0.85);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.6), 0 18px 40px rgba(0, 0, 0, 0.6);
    }

    #scan-status {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    #scan-list {
      max-height: 60vh;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .scan-row {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 0.85rem;
      cursor: pointer;
    }

    .scan-row:last-child { border-bottom: none; }

    .scan-row-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-weight: 600;
    }

    .scan-row-meta {
      font-size: 0.7rem;
      opacity: 0.75;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .empty-state {
      text-align: center;
      padding: 16px;
      font-size: 0.85rem;
      opacity: 0.7;
    }

    .subtle {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    .detail-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.9rem;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .detail-label {
      font-weight: 500;
      opacity: 0.8;
    }

    .detail-value {
      text-align: right;
      word-break: break-word;
      max-width: 65%;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="card">
      <header>
        <h1 id="app-title">
          <span class="logo-dot"></span>
          밋 트래커
        </h1>
        <div class="pill">
          <span class="pill-dot"></span>
          <span id="pill-status">준비 완료</span>
        </div>
      </header>

      <div class="top-controls">
        <button id="lang-toggle" class="btn btn-outline" type="button">한국어</button>
        <button id="theme-toggle" class="btn btn-outline" type="button">자동</button>
      </div>

      <!-- Screen 1 -->
      <section id="screen-1" class="screen active">
        <p class="subtle" id="intro-text">
          만나서 서로 스캔할 수 있는 나만의 QR 카드를 만들어 보세요.
        </p>

        <div class="field">
          <label for="fullName" id="label-fullname">이름</label>
          <input id="fullName" placeholder="예: 김민수" />
        </div>

        <div class="field">
          <label for="group" id="label-group">순 (Group)</label>
          <select id="group">
            <option value="" disabled selected>선택하세요</option>
            <!-- 가나다 순 -->
            <option value="김수진">김수진</option>
            <option value="랠리스">랠리스</option>
            <option value="류다현">류다현</option>
            <option value="무소속">무소속</option>
            <option value="새가족">새가족</option>
            <option value="아이린">아이린</option>
            <option value="장준용">장준용</option>
            <option value="조연수">조연수</option>
            <option value="최우석">최우석</option>
          </select>
        </div>

        <div class="field">
          <label for="mbti" id="label-mbti">MBTI</label>
          <input id="mbti" placeholder="예: INFP" />
        </div>

        <div class="field">
          <label for="location" id="label-location">사는 곳</label>
          <input id="location" placeholder="예: 서울, 대한민국" />
        </div>

        <div class="field">
          <label for="hobby" id="label-hobby">취미</label>
          <input id="hobby" placeholder="예: 등산, 커피, 게임" />
        </div>

        <button id="save-profile" class="btn btn-primary" type="button">
          내 정보 저장하고 QR 보기
        </button>
      </section>

      <!-- Screen 2 -->
      <section id="screen-2" class="screen">
        <div class="chip-list" id="profile-summary"></div>

        <div class="qr-box">
          <div id="qrcode"></div>
        </div>

        <div class="link-row">
          <div class="link-tile" id="open-met-list">
            <span class="link-tile-title" id="met-title">만난 사람</span>
            <span class="scanned-count" id="met-count">0</span>
            <span class="link-tile-sub" id="met-subtitle">지금까지 만난 사람 목록 보기</span>
          </div>

          <div style="width: 10px;"></div>

          <button id="open-scanner" class="btn btn-primary" type="button">
            QR 스캔하기
          </button>
        </div>

        <div class="meta-row">
          <span class="subtle" id="qr-description">
            QR에는 이름, 순, MBTI, 사는 곳, 취미 정보가 들어갑니다.
          </span>
          <button id="edit-profile" class="btn btn-outline" type="button">내 정보 수정</button>
        </div>
      </section>

      <!-- Screen 3 -->
      <section id="screen-3" class="screen">
        <div id="scanner-container">
          <video id="video" playsinline></video>
          <canvas id="scan-canvas" style="display:none;"></canvas>
          <div id="scan-overlay">
            <div id="scan-overlay-inner"></div>
          </div>
        </div>

        <div class="meta-row">
          <span id="scan-status">QR를 가운데 네모 안에 맞추고 잠시만 기다려 주세요…</span>
          <div style="display:flex;gap:6px;">
            <button id="flip-camera" class="btn btn-outline" type="button">
              카메라 전환
            </button>
            <button id="stop-scan" class="btn btn-outline" type="button">
              완료
            </button>
          </div>
        </div>
      </section>

      <!-- Screen 4 -->
      <section id="screen-4" class="screen">
        <div class="meta-row">
          <span class="subtle" id="met-list-title">지금까지 만난 사람</span>
          <button id="back-to-main" class="btn btn-outline" type="button">
            뒤로
          </button>
        </div>

        <div id="scan-list"></div>

        <div class="footer-row">
          <button id="clear-met" class="btn btn-outline" type="button">전체 삭제</button>
          <button id="back-to-qr" class="btn btn-primary" type="button">내 QR 보기</button>
        </div>
      </section>

      <!-- Screen 5 -->
      <section id="screen-5" class="screen">
        <div class="meta-row">
          <span class="subtle" id="detail-title">상세 정보</span>
          <button id="back-from-detail" class="btn btn-outline" type="button">
            뒤로
          </button>
        </div>

        <div class="detail-list">
          <div class="detail-row">
            <span class="detail-label" id="detail-label-name">이름</span>
            <span class="detail-value" id="detail-name"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label" id="detail-label-group">순 (Group)</span>
            <span class="detail-value" id="detail-group"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label" id="detail-label-mbti">MBTI</span>
            <span class="detail-value" id="detail-mbti"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label" id="detail-label-location">사는 곳</span>
            <span class="detail-value" id="detail-location"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label" id="detail-label-hobby">취미</span>
            <span class="detail-value" id="detail-hobby"></span>
          </div>
          <div class="detail-row">
            <span class="detail-label" id="detail-label-mettime">만난 시간</span>
            <span class="detail-value" id="detail-mettime"></span>
          </div>
        </div>
      </section>
    </div>

    <p class="subtle" id="footer-text" style="text-align:center;margin-top:4px;">
      데이터는 이 브라우저 안에만 저장됩니다 (쿠키 사용).
    </p>
  </div>

  <script>
    // ---------- Cookies ----------
    function setCookie(name, value, days) {
      const d = new Date();
      d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
      document.cookie = name + "=" + encodeURIComponent(value) +
        ";expires=" + d.toUTCString() + ";path=/";
    }

    function getCookie(name) {
      const cname = name + "=";
      const decoded = decodeURIComponent(document.cookie);
      const parts = decoded.split(";");
      for (let c of parts) {
        c = c.trim();
        if (c.indexOf(cname) === 0) {
          return c.substring(cname.length);
        }
      }
      return "";
    }

    // ---------- State ----------
    const profileCookieKey = "meet_profile";
    const metCookieKey = "meet_met_list";
    const themeCookieKey = "meet_theme";
    const langCookieKey = "meet_lang";

    let profile = null;
    let metList = [];
    let themeMode = "auto";
    let currentLang = "ko";

    let videoStream = null;
    let usingRear = true;
    let scanLoopId = null;
    let lastScannedValue = null;
    let lastDecodeTime = 0;

    // ---------- i18n ----------
    const STRINGS = {
      ko: {
        appTitle: "밋 트래커",
        pillReady: "준비 완료",
        pillSaved: "프로필이 저장되었습니다",
        pillLoaded: "쿠키에서 불러왔습니다",
        pillSetup: "프로필을 먼저 설정해 주세요",

        langButton: "한국어",
        themeAuto: "자동",
        themeDark: "다크",
        themeLight: "라이트",

        intro: "만나서 서로 스캔할 수 있는 나만의 QR 카드를 만들어 보세요.",
        fullNameLabel: "이름",
        fullNamePlaceholder: "예: 김민수",
        groupLabel: "순 (Group)",
        groupPlaceholder: "선택하세요",
        hobbyLabel: "취미",
        hobbyPlaceholder: "예: 등산, 커피, 게임",
        mbtiLabel: "MBTI",
        mbtiPlaceholder: "예: INFP",
        locationLabel: "사는 곳",
        locationPlaceholder: "예: 서울, 대한민국",
        saveProfile: "내 정보 저장하고 QR 보기",
        editProfile: "내 정보 수정",

        metTitle: "만난 사람",
        metSubtitle: "지금까지 만난 사람 목록 보기",
        qrDescription: "QR에는 이름, 순, MBTI, 사는 곳, 취미 정보가 들어갑니다.",
        scanButton: "QR 스캔하기",

        scanStatusIntro: "QR를 가운데 네모 안에 맞추고 잠시만 기다려 주세요…",
        scanStatusTrying: "QR를 읽는 중입니다… 조금 더 가까이 가져가고 가만히 있어 보세요.",
        scanStatusStopped: "스캐너가 종료되었습니다.",
        scanStatusFormatUnsupported: "QR은 인식했지만 이 앱에서 사용하는 형식이 아닙니다.",
        scanStatusMissingName: "QR은 인식했지만 이름이 없습니다.",

        flipCamera: "카메라 전환",
        doneScan: "완료",

        metListTitle: "지금까지 만난 사람",
        clearMet: "전체 삭제",
        back: "뒤로",
        backToQR: "내 QR 보기",

        emptyState: "아직 아무도 없어요. 누군가를 만나서 QR를 스캔해 보세요!",
        footer: "데이터는 이 브라우저 안에만 저장됩니다 (쿠키 사용).",

        detailTitle: "상세 정보",
        detailLabelName: "이름",
        detailLabelGroup: "순 (Group)",
        detailLabelMbti: "MBTI",
        detailLabelLocation: "사는 곳",
        detailLabelHobby: "취미",
        detailLabelMetTime: "만난 시간",

        alertEnterRequired: "모든 항목을 입력해 주세요.",
        alertClearConfirm: "정말로 만난 사람 목록을 모두 삭제할까요?",
        alertScanned: name => `스캔 완료: ${name} 님 정보를 저장했습니다.`,
        alertCameraUnsupported: "이 브라우저에서는 카메라를 사용할 수 없습니다.",
        alertCameraError: msg => `카메라에 접근할 수 없습니다: ${msg}`
      },
      en: {
        appTitle: "Meet Tracker",
        pillReady: "Ready",
        pillSaved: "Profile saved",
        pillLoaded: "Loaded from cookie",
        pillSetup: "Please set up your profile first",

        langButton: "English",
        themeAuto: "Auto",
        themeDark: "Dark",
        themeLight: "Light",

        intro: "Create your own QR card so you can scan each other when you meet.",
        fullNameLabel: "Full name",
        fullNamePlaceholder: "e.g. Alex Kim",
        groupLabel: "Group",
        groupPlaceholder: "Select",
        hobbyLabel: "Hobby",
        hobbyPlaceholder: "e.g. hiking, coffee, games",
        mbtiLabel: "MBTI",
        mbtiPlaceholder: "e.g. INFP",
        locationLabel: "Where do you live?",
        locationPlaceholder: "e.g. Seoul, South Korea",
        saveProfile: "Save my info & show QR",
        editProfile: "Edit my info",

        metTitle: "People you’ve met",
        metSubtitle: "See the people you’ve met so far",
        qrDescription: "Your QR includes your name, group, MBTI, city and hobbies.",
        scanButton: "Scan QR",

        scanStatusIntro: "Align the QR inside the square and hold still…",
        scanStatusTrying: "Trying to read the QR… move a bit closer and hold still.",
        scanStatusStopped: "Scanner stopped.",
        scanStatusFormatUnsupported: "QR detected, but format is not supported by this app.",
        scanStatusMissingName: "QR detected, but name is missing.",

        flipCamera: "Flip camera",
        doneScan: "Done",

        metListTitle: "People you’ve met",
        clearMet: "Clear list",
        back: "Back",
        backToQR: "My QR",

        emptyState: "No one yet. Go meet someone and scan their QR!",
        footer: "Data stays in this browser only (stored in cookies).",

        detailTitle: "Person details",
        detailLabelName: "Name",
        detailLabelGroup: "Group",
        detailLabelMbti: "MBTI",
        detailLabelLocation: "Location",
        detailLabelHobby: "Hobby",
        detailLabelMetTime: "Met at",

        alertEnterRequired: "Please fill in all fields.",
        alertClearConfirm: "Clear all entries in 'People you’ve met'?",
        alertScanned: name => `Scanned and saved: ${name}`,
        alertCameraUnsupported: "Camera access is not supported in this browser.",
        alertCameraError: msg => `Unable to access camera: ${msg}`
      }
    };

    function t(key, ...args) {
      const s = STRINGS[currentLang][key];
      return typeof s === "function" ? s(...args) : (s ?? "");
    }

    // ---------- DOM refs ----------
    const screens = {
      s1: document.getElementById("screen-1"),
      s2: document.getElementById("screen-2"),
      s3: document.getElementById("screen-3"),
      s4: document.getElementById("screen-4"),
      s5: document.getElementById("screen-5"),
    };

    const appTitleEl = document.getElementById("app-title");
    const pillStatus = document.getElementById("pill-status");
    const langToggleBtn = document.getElementById("lang-toggle");
    const themeToggleBtn = document.getElementById("theme-toggle");
    const introText = document.getElementById("intro-text");

    const fullNameLabel = document.getElementById("label-fullname");
    const groupLabel = document.getElementById("label-group");
    const mbtiLabel = document.getElementById("label-mbti");
    const locationLabel = document.getElementById("label-location");
    const hobbyLabel = document.getElementById("label-hobby");

    const fullNameInput = document.getElementById("fullName");
    const groupSelect = document.getElementById("group");
    const mbtiInput = document.getElementById("mbti");
    const locationInput = document.getElementById("location");
    const hobbyInput = document.getElementById("hobby");
    const saveProfileBtn = document.getElementById("save-profile");
    const editProfileBtn = document.getElementById("edit-profile");

    const profileSummary = document.getElementById("profile-summary");
    const metTitleEl = document.getElementById("met-title");
    const metSubtitleEl = document.getElementById("met-subtitle");
    const qrDescriptionEl = document.getElementById("qr-description");
    const metCount = document.getElementById("met-count");
    const scanListEl = document.getElementById("scan-list");

    const scanStatus = document.getElementById("scan-status");
    const flipCameraBtn = document.getElementById("flip-camera");
    const stopScanBtn = document.getElementById("stop-scan");
    const openScannerBtn = document.getElementById("open-scanner");

    const metListTitleEl = document.getElementById("met-list-title");
    const clearMetBtn = document.getElementById("clear-met");
    const backToMainBtn = document.getElementById("back-to-main");
    const backToQrBtn = document.getElementById("back-to-qr");
    const footerTextEl = document.getElementById("footer-text");

    const detailTitleEl = document.getElementById("detail-title");
    const backFromDetailBtn = document.getElementById("back-from-detail");
    const detailName = document.getElementById("detail-name");
    const detailGroup = document.getElementById("detail-group");
    const detailMbti = document.getElementById("detail-mbti");
    const detailLocation = document.getElementById("detail-location");
    const detailHobby = document.getElementById("detail-hobby");
    const detailMetTime = document.getElementById("detail-mettime");
    const detailLabelName = document.getElementById("detail-label-name");
    const detailLabelGroup = document.getElementById("detail-label-group");
    const detailLabelMbti = document.getElementById("detail-label-mbti");
    const detailLabelLocation = document.getElementById("detail-label-location");
    const detailLabelHobby = document.getElementById("detail-label-hobby");
    const detailLabelMetTime = document.getElementById("detail-label-mettime");

    const videoEl = document.getElementById("video");
    const scanCanvas = document.getElementById("scan-canvas");

    function showScreen(name) {
      Object.values(screens).forEach(el => el.classList.remove("active"));
      if (screens[name]) screens[name].classList.add("active");
    }

    function applyTheme() {
      document.body.classList.remove("dark", "light");
      if (themeMode === "dark") document.body.classList.add("dark");
      else if (themeMode === "light") document.body.classList.add("light");
      themeToggleBtn.textContent =
        themeMode === "auto" ? t("themeAuto") :
        themeMode === "dark" ? t("themeDark") :
        t("themeLight");
    }

    function applyLanguage() {
      document.documentElement.lang = currentLang === "ko" ? "ko" : "en";
      document.title = t("appTitle");

      appTitleEl.innerHTML = `<span class="logo-dot"></span>${t("appTitle")}`;
      langToggleBtn.textContent = t("langButton");

      introText.textContent = t("intro");
      fullNameLabel.textContent = t("fullNameLabel");
      groupLabel.textContent = t("groupLabel");
      mbtiLabel.textContent = t("mbtiLabel");
      locationLabel.textContent = t("locationLabel");
      hobbyLabel.textContent = t("hobbyLabel");

      fullNameInput.placeholder = t("fullNamePlaceholder");
      groupSelect.options[0].textContent = t("groupPlaceholder");
      mbtiInput.placeholder = t("mbtiPlaceholder");
      locationInput.placeholder = t("locationPlaceholder");
      hobbyInput.placeholder = t("hobbyPlaceholder");

      saveProfileBtn.textContent = t("saveProfile");
      editProfileBtn.textContent = t("editProfile");

      metTitleEl.textContent = t("metTitle");
      metSubtitleEl.textContent = t("metSubtitle");
      qrDescriptionEl.textContent = t("qrDescription");
      openScannerBtn.textContent = t("scanButton");

      flipCameraBtn.textContent = t("flipCamera");
      stopScanBtn.textContent = t("doneScan");
      scanStatus.textContent = t("scanStatusIntro");

      metListTitleEl.textContent = t("metListTitle");
      clearMetBtn.textContent = t("clearMet");
      backToMainBtn.textContent = t("back");
      backToQrBtn.textContent = t("backToQR");
      backFromDetailBtn.textContent = t("back");
      footerTextEl.textContent = t("footer");

      detailTitleEl.textContent = t("detailTitle");
      detailLabelName.textContent = t("detailLabelName");
      detailLabelGroup.textContent = t("detailLabelGroup");
      detailLabelMbti.textContent = t("detailLabelMbti");
      detailLabelLocation.textContent = t("detailLabelLocation");
      detailLabelHobby.textContent = t("detailLabelHobby");
      detailLabelMetTime.textContent = t("detailLabelMetTime");

      applyTheme();
    }

    function toggleLanguage() {
      currentLang = currentLang === "ko" ? "en" : "ko";
      setCookie(langCookieKey, currentLang, 365);
      applyLanguage();
      updateProfileSummary();
      renderMetList();
    }

    function toggleTheme() {
      if (themeMode === "auto") themeMode = "dark";
      else if (themeMode === "dark") themeMode = "light";
      else themeMode = "auto";
      setCookie(themeCookieKey, themeMode, 365);
      applyTheme();
    }

    // ---------- QR payload encoding ----------
    // v1: <compressedUsingLZString>
    function encodeProfileForQR(p) {
      const obj = {
        v: 1,
        fullName: p.fullName || "",
        group: p.group || "",
        mbti: p.mbti || "",
        location: p.location || "",
        hobby: p.hobby || ""
      };
      const json = JSON.stringify(obj);
      const compressed = LZString.compressToEncodedURIComponent(json);
      return "v1:" + compressed;
    }

    function decodeProfileFromQR(str) {
      if (str.startsWith("v1:")) {
        const payload = str.slice(3);
        const json = LZString.decompressFromEncodedURIComponent(payload);
        if (!json) throw new Error("Failed to decompress QR payload");
        const obj = JSON.parse(json);
        return {
          fullName: obj.fullName || "",
          group: obj.group || "",
          mbti: obj.mbti || "",
          location: obj.location || "",
          hobby: obj.hobby || ""
        };
      } else {
        // fallback: old format name|group|mbti|location|hobby
        const parts = str.split("|");
        return {
          fullName: (parts[0] || "").trim(),
          group: (parts[1] || "").trim(),
          mbti: (parts[2] || "").trim(),
          location: (parts[3] || "").trim(),
          hobby: (parts[4] || "").trim()
        };
      }
    }

    // ---------- QR (using local qrcode.min.js) ----------
    function updateQR() {
      if (!profile) return;

      const qrContainer = document.getElementById("qrcode");
      if (!qrContainer) return;

      // no hard clamp needed anymore, but we still prevent insane sizes
      const limit = 500;
      function clamp(str) {
        if (!str) return "";
        return str.length > limit ? str.slice(0, limit) : str;
      }

      profile = {
        fullName: clamp(profile.fullName),
        group: clamp(profile.group),
        mbti: clamp(profile.mbti),
        location: clamp(profile.location),
        hobby: clamp(profile.hobby)
      };
      setCookie(profileCookieKey, JSON.stringify(profile), 365);

      const data = encodeProfileForQR(profile);

      qrContainer.innerHTML = "";

      if (typeof QRCode === "undefined") {
        const msg = document.createElement("div");
        msg.style.textAlign = "center";
        msg.style.fontSize = "0.8rem";
        msg.style.opacity = "0.8";
        msg.textContent = currentLang === "ko"
          ? "QRCode 라이브러리를 찾을 수 없습니다. qrcode.min.js 경로를 확인해 주세요."
          : "QRCode library not found. Please check qrcode.min.js path.";
        qrContainer.appendChild(msg);
        return;
      }

      try {
        new QRCode(qrContainer, {
          text: data,
          width: 300,
          height: 300,
          colorDark: "#000000",
          colorLight: "#ffffff",
          correctLevel: QRCode.CorrectLevel.L
        });
      } catch (e) {
        console.error("QR generation error:", e, "len:", data.length);
        const fallback = document.createElement("div");
        fallback.style.textAlign = "center";
        fallback.style.fontSize = "0.8rem";
        fallback.style.opacity = "0.8";
        fallback.textContent = currentLang === "ko"
          ? "QR 코드를 생성하는 중 오류가 발생했습니다."
          : "Error while generating QR code.";
        qrContainer.appendChild(fallback);
      }
    }

    function updateProfileSummary() {
      profileSummary.innerHTML = "";
      if (!profile) return;

      const labelName = currentLang === "ko" ? "이름" : "Name";
      const labelGroup = currentLang === "ko" ? "순" : "Group";
      const labelMbti = "MBTI";
      const labelCity = currentLang === "ko" ? "사는 곳" : "Location";
      const labelHobby = currentLang === "ko" ? "취미" : "Hobby";

      const items = [
        { label: labelName, value: profile.fullName },
        { label: labelGroup, value: profile.group },
        { label: labelMbti, value: profile.mbti },
        { label: labelCity, value: profile.location },
        { label: labelHobby, value: profile.hobby },
      ];

      items.forEach(i => {
        if (!i.value) return;
        const chip = document.createElement("div");
        chip.className = "chip";
        const spanLabel = document.createElement("span");
        spanLabel.className = "label";
        spanLabel.textContent = i.label;
        const strongVal = document.createElement("strong");
        strongVal.textContent = i.value;
        chip.appendChild(spanLabel);
        chip.appendChild(strongVal);
        profileSummary.appendChild(chip);
      });
    }

    function updateMetCount() {
      metCount.textContent = String(metList.length);
    }

    function renderMetList() {
      scanListEl.innerHTML = "";
      if (!metList.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = t("emptyState");
        scanListEl.appendChild(empty);
        return;
      }

      const labelGroup = currentLang === "ko" ? "순" : "Group";

      const sorted = metList
        .map((item, idx) => ({ item, idx }))
        .sort((a, b) => b.item.timestamp - a.item.timestamp);

      sorted.forEach(({ item, idx }) => {
        const row = document.createElement("div");
        row.className = "scan-row";
        row.dataset.index = String(idx);

        const header = document.createElement("div");
        header.className = "scan-row-header";
        const nameEl = document.createElement("div");
        nameEl.textContent = item.name || (currentLang === "ko" ? "이름 없음" : "Unknown");

        const timeEl = document.createElement("div");
        const dt = new Date(item.timestamp);
        timeEl.textContent = dt.toLocaleString();
        timeEl.style.fontSize = "0.75rem";
        timeEl.style.opacity = "0.8";

        header.appendChild(nameEl);
        header.appendChild(timeEl);

        const meta = document.createElement("div");
        meta.className = "scan-row-meta";
        const groupSpan = document.createElement("span");
        groupSpan.textContent = `${labelGroup}: ${item.group || "-"}`;
        meta.appendChild(groupSpan);

        row.appendChild(header);
        row.appendChild(meta);
        scanListEl.appendChild(row);
      });
    }

    function saveProfileFromInputs() {
      let fullName = fullNameInput.value.trim();
      let group = groupSelect.value.trim();
      let mbti = mbtiInput.value.trim();
      let location = locationInput.value.trim();
      let hobby = hobbyInput.value.trim();

      if (!fullName || !group || !mbti || !location || !hobby) {
        alert(t("alertEnterRequired"));
        return false;
      }

      profile = { fullName, group, mbti, location, hobby };
      setCookie(profileCookieKey, JSON.stringify(profile), 365);
      return true;
    }

    function saveMetList() {
      setCookie(metCookieKey, JSON.stringify(metList), 365);
    }

    async function startScanner() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert(t("alertCameraUnsupported"));
        return;
      }
      try {
        pillStatus.textContent = t("pillReady");
        lastScannedValue = null;
        scanStatus.textContent = t("scanStatusIntro");

        const constraints = {
          video: {
            facingMode: usingRear ? { ideal: "environment" } : "user",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          },
          audio: false
        };
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        videoEl.srcObject = videoStream;

        await new Promise(resolve => {
          if (videoEl.readyState >= 2) resolve();
          else videoEl.onloadedmetadata = () => resolve();
        });

        await videoEl.play();
        showScreen("s3");
        startScanLoop();
      } catch (err) {
        console.error(err);
        alert(t("alertCameraError", err.message));
        pillStatus.textContent = t("pillReady");
      }
    }

    function stopScanner() {
      if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
      }
      if (scanLoopId) {
        cancelAnimationFrame(scanLoopId);
        scanLoopId = null;
      }
      videoEl.srcObject = null;
      scanStatus.textContent = t("scanStatusStopped");
      pillStatus.textContent = t("pillReady");
      showScreen("s2");
    }

    function startScanLoop() {
      const ctx = scanCanvas.getContext("2d");

      const loop = () => {
        if (!videoStream) return;

        const now = performance.now();
        if (now - lastDecodeTime < 200) {
          scanLoopId = requestAnimationFrame(loop);
          return;
        }
        lastDecodeTime = now;

        if (videoEl.readyState === videoEl.HAVE_ENOUGH_DATA) {
          const vw = videoEl.videoWidth;
          const vh = videoEl.videoHeight;
          if (vw && vh) {
            scanCanvas.width = vw;
            scanCanvas.height = vh;
            ctx.drawImage(videoEl, 0, 0, vw, vh);

            const size = Math.floor(Math.min(vw, vh) * 0.7);
            const x = Math.floor((vw - size) / 2);
            const y = Math.floor((vh - size) / 2);
            const imageData = ctx.getImageData(x, y, size, size);

            const code = jsQR(imageData.data, imageData.width, imageData.height, {
              inversionAttempts: "dontInvert"
            });

            if (code && code.data) {
              if (code.data !== lastScannedValue) {
                lastScannedValue = code.data;
                handleScannedData(code.data);
              }
            } else {
              scanStatus.textContent = t("scanStatusTrying");
            }
          }
        }
        scanLoopId = requestAnimationFrame(loop);
      };
      loop();
    }

    function handleScannedData(dataStr) {
      let decodedProfile;
      try {
        decodedProfile = decodeProfileFromQR(dataStr);
      } catch (e) {
        console.error("Failed to decode profile from QR:", e);
        scanStatus.textContent = t("scanStatusFormatUnsupported");
        return;
      }

      const name = (decodedProfile.fullName || "").trim();
      if (!name) {
        scanStatus.textContent = t("scanStatusMissingName");
        return;
      }

      const group = decodedProfile.group || "";
      const mbti = decodedProfile.mbti || "";
      const location = decodedProfile.location || "";
      const hobby = decodedProfile.hobby || "";

      const existing = metList.find(
        m =>
          m.name === name &&
          (m.group || "") === group &&
          (m.mbti || "") === mbti &&
          (m.location || "") === location &&
          (m.hobby || "") === hobby
      );

      if (!existing) {
        metList.push({
          name,
          group,
          mbti,
          location,
          hobby,
          timestamp: Date.now(),
        });
        saveMetList();
        updateMetCount();
      }

      alert(t("alertScanned", name));
      stopScanner();
      renderMetList();
      showScreen("s4");
    }

    function wireEvents() {
      langToggleBtn.addEventListener("click", toggleLanguage);
      themeToggleBtn.addEventListener("click", toggleTheme);

      saveProfileBtn.addEventListener("click", () => {
        if (!saveProfileFromInputs()) return;

        pillStatus.textContent = t("pillSaved");
        updateProfileSummary();
        showScreen("s2");
        updateQR();
      });

      editProfileBtn.addEventListener("click", () => {
        if (profile) {
          fullNameInput.value = profile.fullName || "";
          groupSelect.value = profile.group || "";
          mbtiInput.value = profile.mbti || "";
          locationInput.value = profile.location || "";
          hobbyInput.value = profile.hobby || "";
        }
        showScreen("s1");
      });

      clearMetBtn.addEventListener("click", () => {
        if (!metList.length) return;
        if (!confirm(t("alertClearConfirm"))) return;
        metList = [];
        saveMetList();
        updateMetCount();
        renderMetList();
      });

      document.getElementById("open-met-list").addEventListener("click", () => {
        renderMetList();
        showScreen("s4");
      });

      backToMainBtn.addEventListener("click", () => showScreen("s2"));
      backToQrBtn.addEventListener("click", () => showScreen("s2"));
      backFromDetailBtn.addEventListener("click", () => showScreen("s4"));

      openScannerBtn.addEventListener("click", startScanner);
      stopScanBtn.addEventListener("click", stopScanner);
      flipCameraBtn.addEventListener("click", async () => {
        usingRear = !usingRear;
        stopScanner();
        await startScanner();
      });

      scanListEl.addEventListener("click", e => {
        const row = e.target.closest(".scan-row");
        if (!row) return;
        const idx = parseInt(row.dataset.index, 10);
        const person = metList[idx];
        if (!person) return;

        detailName.textContent = person.name || "";
        detailGroup.textContent = person.group || "";
        detailMbti.textContent = person.mbti || "";
        detailLocation.textContent = person.location || "";
        detailHobby.textContent = person.hobby || "";
        detailMetTime.textContent = person.timestamp
          ? new Date(person.timestamp).toLocaleString()
          : "";

        showScreen("s5");
      });
    }

    function loadCookies() {
      const storedLang = getCookie(langCookieKey);
      if (storedLang === "ko" || storedLang === "en") currentLang = storedLang;

      const storedTheme = getCookie(themeCookieKey);
      if (storedTheme === "auto" || storedTheme === "dark" || storedTheme === "light") {
        themeMode = storedTheme;
      }

      const storedProfile = getCookie(profileCookieKey);
      if (storedProfile) {
        try { profile = JSON.parse(storedProfile); } catch { profile = null; }
      }

      const storedMet = getCookie(metCookieKey);
      if (storedMet) {
        try { metList = JSON.parse(storedMet) || []; } catch { metList = []; }
      }
    }

    function initUI() {
      loadCookies();
      applyLanguage();
      wireEvents();

      if (profile) {
        fullNameInput.value = profile.fullName || "";
        groupSelect.value = profile.group || "";
        mbtiInput.value = profile.mbti || "";
        locationInput.value = profile.location || "";
        hobbyInput.value = profile.hobby || "";
        updateProfileSummary();
        updateQR();
        showScreen("s2");
        pillStatus.textContent = t("pillLoaded");
      } else {
        showScreen("s1");
        pillStatus.textContent = t("pillSetup");
      }
      updateMetCount();
      renderMetList();
    }

    window.addEventListener("load", initUI);
  </script>
</body>
</html>
