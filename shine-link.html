<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ÏÉ§Ïù∏ ÎßÅÌÅ¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- QR code reader (for scanning) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>

  <style>
    :root {
      color-scheme: light dark;
      /* Base (light) ‚Äì cozy holiday vibes */
      --bg: #0b1020;
      --fg: #111827;
      --card-bg: #fdf7ec;
      --accent: #b91c1c; /* deep red */
      --accent-soft: rgba(185, 28, 28, 0.18);
      --accent-green: #15803d;
      --accent-gold: #facc15;
      --border: #e5e7eb;
    }

    body.light {
      --bg: #0b1020;
      --fg: #111827;
      --card-bg: #fdf7ec;
      --accent: #b91c1c;
      --accent-soft: rgba(185, 28, 28, 0.18);
      --accent-green: #15803d;
      --accent-gold: #facc15;
      --border: #e5e7eb;
    }

    body.dark {
      /* Dark mode ‚Äì richer navy + green, readable text */
      --bg: #020617;
      --fg: #e5e7eb;
      --card-bg: #020a18;
      --accent: #22c55e; /* green accent */
      --accent-soft: rgba(34, 197, 94, 0.22);
      --accent-green: #22c55e;
      --accent-gold: #facc15;
      --border: #1f2937;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top left, rgba(220, 38, 38, 0.22), transparent 55%),
        radial-gradient(circle at top right, rgba(22, 163, 74, 0.26), transparent 60%),
        radial-gradient(circle at bottom, rgba(250, 204, 21, 0.18), var(--bg) 70%);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    #app {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }

    .card {
      background: var(--card-bg);
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow:
        0 22px 50px rgba(15, 23, 42, 0.45),
        0 0 0 1px rgba(148, 163, 184, 0.15);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    /* subtle sparkle / ribbon overlay */
    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      pointer-events: none;
      background:
        linear-gradient(135deg, rgba(250, 250, 250, 0.26), transparent 50%),
        radial-gradient(circle at top right, rgba(250, 204, 21, 0.28), transparent 60%),
        linear-gradient(
          60deg,
          transparent 0,
          transparent 40%,
          rgba(254, 202, 202, 0.35) 50%,
          transparent 60%,
          transparent 100%
        );
      mix-blend-mode: soft-light;
      opacity: 0.9;
    }

    .card > * { position: relative; }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    header h1 {
      font-size: 1.1rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    header h1 span.logo-dot {
      width: 11px;
      height: 11px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fefce8, var(--accent-gold));
      box-shadow:
        0 0 0 4px rgba(250, 204, 21, 0.25),
        0 0 12px rgba(250, 204, 21, 0.6);
    }

    .pill {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(250, 204, 21, 0.7);
      background: rgba(250, 250, 250, 0.7);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #92400e;
    }

    body.dark .pill {
      background: rgba(31, 41, 55, 0.95);
      color: #fef9c3;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent-gold);
      box-shadow: 0 0 6px rgba(250, 204, 21, 0.9);
    }

    .screen {
      display: none;
      flex-direction: column;
      gap: 12px;
    }

    .screen.active { display: flex; }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .field label {
      font-size: 0.8rem;
      font-weight: 500;
    }

    .field input {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.02);
      color: var(--fg);
      font-size: 0.9rem;
    }

    body.dark .field input {
      background: rgba(15, 23, 42, 0.8);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .field input:focus {
      outline: 2px solid var(--accent-soft);
      border-color: var(--accent);
    }

    .question-block {
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      background:
        linear-gradient(
          135deg,
          rgba(22, 163, 74, 0.06),
          rgba(185, 28, 28, 0.04)
        );
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    body.dark .question-block {
      background:
        radial-gradient(circle at top, rgba(22, 163, 74, 0.28), transparent 65%),
        radial-gradient(circle at bottom, rgba(185, 28, 28, 0.2), transparent 65%);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .question-text {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .options {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 2px;
    }

    .option-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .option-item input {
      margin-top: 2px;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 10px 14px;
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: transform 0.06s ease, box-shadow 0.06s ease, background 0.12s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #be123c);
      color: white;
      box-shadow: 0 10px 25px rgba(185, 28, 28, 0.55);
    }

    body.dark .btn-primary {
      background: linear-gradient(135deg, var(--accent-green), #16a34a);
      box-shadow: 0 10px 28px rgba(16, 185, 129, 0.65);
    }

    .btn-primary:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 12px rgba(185, 28, 28, 0.6);
    }

    body.dark .btn-primary:active {
      box-shadow: 0 4px 14px rgba(16, 185, 129, 0.7);
    }

    .btn-outline {
      background: rgba(248, 250, 252, 0.8);
      border: 1px solid var(--border);
      color: var(--fg);
    }

    body.dark .btn-outline {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
    }

    .btn-outline:active {
      transform: translateY(1px) scale(0.99);
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 0.75rem;
      border-radius: 999px;
    }

    .footer-row {
      display: flex;
      gap: 8px;
      justify-content: space-between;
    }

    .footer-row .btn { flex: 1; }

    .meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }

    .qr-box {
      margin-top: 4px;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
      border-radius: 18px;
      border: 1px dashed rgba(250, 204, 21, 0.7);
      background:
        radial-gradient(circle at top, rgba(250, 204, 21, 0.25), transparent 60%),
        radial-gradient(circle at bottom, rgba(22, 163, 74, 0.22), transparent 60%);
      min-height: 260px;
    }

    body.dark .qr-box {
      background:
        radial-gradient(circle at top, rgba(250, 204, 21, 0.18), transparent 60%),
        radial-gradient(circle at bottom, rgba(34, 197, 94, 0.3), transparent 65%);
      border-color: rgba(250, 250, 250, 0.6);
    }

    .qr-box img {
      max-width: 360px;
      width: 85%;
      height: auto;
      margin: 0 auto;
      display: block;
    }

    .chip-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .chip {
      font-size: 0.75rem;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(248, 250, 252, 0.9);
      border: 1px solid rgba(209, 213, 219, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    body.dark .chip {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .chip span.label { opacity: 0.7; }
    .chip strong { font-weight: 600; }

    .top-controls {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      align-items: center;
      font-size: 0.75rem;
    }

    .link-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .link-tile {
      border-radius: 14px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: rgba(248, 250, 252, 0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
      cursor: pointer;
    }

    body.dark .link-tile {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .link-tile-title {
      font-size: 0.8rem;
      font-weight: 600;
    }

    .link-tile-sub {
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .scanned-count {
      font-size: 1.1rem;
      font-weight: 700;
    }

    #scanner-container {
      position: relative;
      overflow: hidden;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: black;
      height: min(60vh, 420px);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #scan-overlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #scan-overlay-inner {
      width: 80%;
      max-width: 300px;
      aspect-ratio: 1 / 1;
      border-radius: 22px;
      border: 2px solid rgba(248, 250, 252, 0.9);
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.6), 0 18px 40px rgba(0, 0, 0, 0.6);
    }

    #scan-status {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    #scan-list {
      max-height: 60vh;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(248, 250, 252, 0.92);
    }

    body.dark #scan-list {
      background: rgba(15, 23, 42, 0.96);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .scan-row {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85rem;
    }

    .scan-row:last-child { border-bottom: none; }

    .scan-row-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      font-weight: 600;
      align-items: center;
    }

    .scan-row-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
      flex: 1;
    }

    .scan-row-meta {
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .scan-row-subtitle {
      opacity: 0.85;
      flex: 0;
      white-space: nowrap;        /* üí° keep it on one line */
    }

    .scan-row-right {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Full match: green */
    .match-badge-full {
      font-size: 0.75rem;
      border-radius: 999px;
      padding: 2px 6px;
      background: rgba(22, 163, 74, 0.18);
      border: 1px solid rgba(22, 163, 74, 0.95);
      color: #166534;
      font-weight: 600;
      white-space: nowrap;
    }

    body.dark .match-badge-full {
      background: rgba(34, 197, 94, 0.18);
      border-color: rgba(34, 197, 94, 0.95);
      color: #bbf7d0;
    }

    /* Partial match: gold/yellow */
    .match-badge-partial {
      font-size: 0.75rem;
      border-radius: 999px;
      padding: 2px 6px;
      background: rgba(250, 204, 21, 0.2);
      border: 1px solid rgba(250, 204, 21, 0.95);
      color: #92400e;
      font-weight: 500;
      white-space: nowrap;
    }

    body.dark .match-badge-partial {
      background: rgba(250, 204, 21, 0.22);
      color: #fef9c3;
    }

    .empty-state {
      text-align: center;
      padding: 16px;
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .subtle {
      font-size: 0.75rem;
      opacity: 0.9;
    }

    .detail-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      font-size: 0.85rem;
    }

    .detail-question {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .detail-answer-pill {
      display: inline-flex;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(248, 250, 252, 0.9);
      font-size: 0.8rem;
      margin-top: 2px;
    }

    body.dark .detail-answer-pill {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(55, 65, 81, 0.9);
    }

    .detail-answer-same {
      background: linear-gradient(135deg, rgba(250, 204, 21, 0.22), rgba(22, 163, 74, 0.18));
      border-color: rgba(250, 204, 21, 0.95);
      color: #78350f;
      font-weight: 600;
    }

    body.dark .detail-answer-same {
      color: #fef3c7;
    }

    .detail-name {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .detail-mettime {
      font-size: 0.75rem;
      opacity: 0.8;
    }

    /* Toast / in-app dialog */
    #toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%) translateY(100%);
      bottom: 12px;
      z-index: 50;
      max-width: 480px;
      width: calc(100% - 32px);
      pointer-events: none;
      transition: transform 0.25s ease-out, opacity 0.25s ease-out;
      opacity: 0;
    }

    #toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    #toast-inner {
      pointer-events: auto;
      border-radius: 999px;
      padding: 10px 14px;
      border: 1px solid rgba(250, 204, 21, 0.9);
      background: radial-gradient(circle at left, rgba(250, 204, 21, 0.3), transparent 55%),
                  rgba(15, 23, 42, 0.96);
      color: #fefce8;
      box-shadow:
        0 18px 35px rgba(15, 23, 42, 0.85),
        0 0 0 1px rgba(31, 41, 55, 0.8);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
    }

    body.light #toast-inner {
      background: radial-gradient(circle at left, rgba(250, 204, 21, 0.3), transparent 55%),
                  #111827;
      color: #fefce8;
    }

    #toast-icon {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fefce8, var(--accent-gold));
      box-shadow: 0 0 10px rgba(250, 204, 21, 0.8);
      flex-shrink: 0;
    }

    #toast-message {
      flex: 1;
    }

    #toast-close {
      border: none;
      background: transparent;
      color: inherit;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0 2px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="card">
      <header>
        <h1 id="app-title">
          <span class="logo-dot"></span>
        </h1>
        <div class="pill">
          <span class="pill-dot"></span>
          <span id="pill-status">Ï§ÄÎπÑ ÏôÑÎ£å</span>
        </div>
      </header>

      <div class="top-controls">
        <button id="lang-toggle" class="btn btn-outline" type="button">ÌïúÍµ≠Ïñ¥</button>
        <button id="theme-toggle" class="btn btn-outline" type="button">ÏûêÎèô</button>
      </div>

      <!-- Screen 1: My profile & answers -->
      <section id="screen-1" class="screen active">
        <p class="subtle" id="intro-text">
          Ïò§Îäò ÌååÌã∞ÏóêÏÑú ÎÇòÏôÄ ÎπÑÏä∑Ìïú ÏÇ¨ÎûåÏùÑ Ï∞æÏïÑÎ≥ºÍπåÏöî? ÏßàÎ¨∏Ïóê ÎãµÌïòÍ≥† ÎÇòÎßåÏùò QRÏùÑ ÎßåÎì§Ïñ¥ Î≥¥ÏÑ∏Ïöî.
        </p>

        <div class="field">
          <label for="fullName" id="label-fullname">Ïù¥Î¶Ñ</label>
          <!-- updated placeholder here -->
          <input id="fullName" placeholder="Ïòà: ÍπÄÏòàÏàò" />
        </div>

        <div class="question-block" id="q1-block">
          <div class="question-text" id="q1-text">
            Q1. ÏßÄÍ∏à ÎÇ¥ ÎßàÏùåÏÜç Ï∫êÎ°§ÏùÄ?
          </div>
          <div class="options" id="q1-options"></div>
        </div>

        <div class="question-block" id="q2-block">
          <div class="question-text" id="q2-text">
            Q2. Ïò§Îäò ÎÇ¥Í∞Ä Í∞ÄÏû• Í∏∞ÎåÄÌïòÎäî Í±¥?
          </div>
          <div class="options" id="q2-options"></div>
        </div>

        <div class="question-block" id="q3-block">
          <div class="question-text" id="q3-text">
            Q3. Ïò§ÎäòÏùò TMIÎäî?
          </div>
          <div class="options" id="q3-options"></div>
        </div>

        <div class="question-block" id="q4-block">
          <div class="question-text" id="q4-text">
            Q4. Ïò§Îäò ÌååÌã∞ÏóêÏÑú ÎÇòÏùò Ï∫êÎ¶≠ÌÑ∞Îäî?
          </div>
          <div class="options" id="q4-options"></div>
        </div>

        <button id="save-profile" class="btn btn-primary" type="button">
          ÎÇ¥ ÎãµÎ≥Ä Ï†ÄÏû•ÌïòÍ≥† QR Î≥¥Í∏∞
        </button>
      </section>

      <!-- Screen 2: My QR -->
      <section id="screen-2" class="screen">
        <div class="chip-list" id="profile-summary"></div>

        <div class="qr-box">
          <div id="qrcode"></div>
        </div>

        <div class="link-row">
          <div class="link-tile" id="open-met-list">
            <span class="link-tile-title" id="met-title">ÎßåÎÇú ÏÇ¨Îûå</span>
            <span class="scanned-count" id="met-count">0</span>
            <span class="link-tile-sub" id="met-subtitle">ÏßÄÍ∏àÍπåÏßÄ ÎßåÎÇú ÏÇ¨Îûå Î™©Î°ù Î≥¥Í∏∞</span>
          </div>

          <div style="width: 10px;"></div>

          <button id="open-scanner" class="btn btn-primary" type="button">
            QR Ïä§Ï∫îÌïòÍ∏∞
          </button>
        </div>

        <div class="meta-row">
          <span class="subtle" id="qr-description">
            QRÏóêÎäî Ïù¥Î¶ÑÍ≥º ÎÑ§ Í∞ÄÏßÄ ÏßàÎ¨∏Ïóê ÎåÄÌïú ÎãµÏù¥ Îã¥Í≤® ÏûàÏñ¥Ïöî.
          </span>
          <button id="edit-profile" class="btn btn-outline" type="button">ÎÇ¥ ÎãµÎ≥Ä ÏàòÏ†ï</button>
        </div>
      </section>

      <!-- Screen 3: Scanner -->
      <section id="screen-3" class="screen">
        <div id="scanner-container">
          <video id="video" playsinline></video>
          <canvas id="scan-canvas" style="display:none;"></canvas>
          <div id="scan-overlay">
            <div id="scan-overlay-inner"></div>
          </div>
        </div>

        <div class="meta-row">
          <span id="scan-status">QRÎ•º Í∞ÄÏö¥Îç∞ ÎÑ§Î™® ÏïàÏóê ÎßûÏ∂îÍ≥†, ÎÑàÎ¨¥ Í∞ÄÍπåÏù¥ ÎßêÍ≥† ÏÇ¥Ïßù Îñ®Ïñ¥Ï†∏ Î≥¥ÏÑ∏Ïöî.</span>
          <div style="display:flex;gap:6px;">
            <button id="flip-camera" class="btn btn-outline" type="button">
              Ïπ¥Î©îÎùº Ï†ÑÌôò
            </button>
            <button id="stop-scan" class="btn btn-outline" type="button">
              ÏôÑÎ£å
            </button>
          </div>
        </div>
      </section>

      <!-- Screen 4: Met list -->
      <section id="screen-4" class="screen">
        <div class="meta-row">
          <span class="subtle" id="met-list-title">ÏßÄÍ∏àÍπåÏßÄ ÎßåÎÇú ÏÇ¨Îûå</span>
          <button id="back-to-main" class="btn btn-outline" type="button">
            Îí§Î°ú
          </button>
        </div>

        <div id="scan-list"></div>

        <div class="footer-row">
          <button id="clear-met" class="btn btn-outline" type="button">Ï†ÑÏ≤¥ ÏÇ≠Ï†ú</button>
        </div>
      </section>

      <!-- Screen 5: Person detail -->
      <section id="screen-5" class="screen">
        <div class="meta-row">
          <span class="subtle" id="detail-title">ÏÉÅÏÑ∏ Ï†ïÎ≥¥</span>
          <button id="back-from-detail" class="btn btn-outline" type="button">
            Îí§Î°ú
          </button>
        </div>

        <div class="detail-name" id="detail-name"></div>
        <div class="detail-mettime" id="detail-mettime"></div>

        <div class="detail-list" id="detail-qa"></div>
      </section>
    </div>

    <p class="subtle" id="footer-text" style="text-align:center;margin-top:4px;">
      Îç∞Ïù¥ÌÑ∞Îäî Ïù¥ Î∏åÎùºÏö∞Ï†Ä ÏïàÏóêÎßå Ï†ÄÏû•Îê©ÎãàÎã§ (Ïø†ÌÇ§ ÏÇ¨Ïö©).
    </p>

    <!-- Toast / in-app dialog -->
    <div id="toast">
      <div id="toast-inner">
        <div id="toast-icon"></div>
        <div id="toast-message"></div>
        <button id="toast-close" aria-label="close">&times;</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Question model ----------
    const QUESTIONS = {
      ko: [
        {
          id: "q1",
          text: "Q1. ÏßÄÍ∏à ÎÇ¥ ÎßàÏùåÏÜç Ï∫êÎ°§ÏùÄ?",
          options: [
            "ÏßïÍ∏ÄÎ≤®‚ÄîÌïòÏù¥ÌÖêÏÖò Î™®Îìú",
            "Í≥†ÏöîÌïú Î∞§‚ÄîÌèâÏò® Î™®Îìú",
            "Î£®ÎèåÌîÑ‚ÄîÏïΩÍ∞Ñ Îì§Îñ†ÏûàÏùå"
          ]
        },
        {
          id: "q2",
          text: "Q2. Ïò§Îäò ÎÇ¥Í∞Ä Í∞ÄÏû• Í∏∞ÎåÄÌïòÎäî Í±¥?",
          options: [
            "ÏùåÏãù! ÏùåÏãù! Í∑∏Î¶¨Í≥† ÏùåÏãù!",
            "ÏÇ¨ÎûåÎì§Í≥ºÏùò ÏàòÎã§",
            "ÏòàÏÉÅ Î™ªÌïú ÏõÉÍ∏¥ Ïù¥Î≤§Ìä∏"
          ]
        },
        {
          id: "q3",
          text: "Q3. Ïò§ÎäòÏùò TMIÎäî?",
          options: [
            "ÏÇ¨Ïã§ Ïò§Îäò Ìå®ÏÖòÏùÄ 5Î∂Ñ Ïª∑Ïù¥Îã§",
            "Ïò¨ ÎïåÎ∂ÄÌÑ∞ Î∞∞Í≥†Ìå†Îã§",
            "ÏôúÏù∏ÏßÄ ÏÑ§Î†åÎã§"
          ]
        },
        {
          id: "q4",
          text: "Q4. Ïò§Îäò ÌååÌã∞ÏóêÏÑú ÎÇòÏùò Ï∫êÎ¶≠ÌÑ∞Îäî?",
          options: [
            "Î®ºÏ†Ä Îã§Í∞ÄÍ∞Ä Î∞òÍ∞ëÍ≤å Ïù∏ÏÇ¨ÌïòÎäî ‚ÄòÏÉ¨Î°¨ Ï†ÑÎèÑÏÇ¨‚Äô",
            "Ï°∞Ïö©Ìûà Ï£ºÎ≥ÄÏùÑ Îî∞ÎúªÌïòÍ≤å ÏßÄÏºúÎ≥¥Îäî ‚ÄòÌèâÏïà ÏàòÌò∏Ïûê‚Äô",
            "Ïò§Îäò ÌååÌã∞Î•º ÏÇ¨ÏßÑÏúºÎ°ú ÎÇ®Í∏∞Î†§Îäî ‚ÄòÏ∂îÏñµ Í∏∞Î°ùÏûê‚Äô"
          ]
        }
      ],
      en: [
        {
          id: "q1",
          text: "Q1. What‚Äôs your inner carol right now?",
          options: [
            "Jingle Bells ‚Äì high-tension mode",
            "Silent Night ‚Äì peaceful mode",
            "Rudolph ‚Äì a bit excited"
          ]
        },
        {
          id: "q2",
          text: "Q2. What are you most excited about today?",
          options: [
            "Food! Food! And more food!",
            "Chatting with people",
            "Unexpected funny moments"
          ]
        },
        {
          id: "q3",
          text: "Q3. Today‚Äôs TMI is‚Ä¶",
          options: [
            "My outfit took exactly 5 minutes",
            "I was hungry on the way here",
            "I feel weirdly fluttery"
          ]
        },
        {
          id: "q4",
          text: "Q4. My party character today is‚Ä¶",
          options: [
            "The one who greets first ‚Äì ‚ÄòShalom Ambassador‚Äô",
            "Quietly guarding the peace ‚Äì ‚ÄòGuardian of Calm‚Äô",
            "Capturing everything ‚Äì ‚ÄòMemory Keeper‚Äô"
          ]
        }
      ]
    };

    function getQuestions() {
      return QUESTIONS[currentLang];
    }

    // Helper: stable short title from Q4 option index
    function getQ4ShortTitle(optionText, index) {
      if (currentLang === "ko") {
        const map = ["ÏÉ¨Î°¨ Ï†ÑÎèÑÏÇ¨", "ÌèâÏïà ÏàòÌò∏Ïûê", "Ï∂îÏñµ Í∏∞Î°ùÏûê"];
        if (index != null && map[index]) return map[index];
      } else {
        const map = ["Shalom Ambassador", "Guardian of Calm", "Memory Keeper"];
        if (index != null && map[index]) return map[index];
      }
      // Fallback: try quotes
      if (optionText) {
        const quoteMatch = optionText.match(/[‚Äò'"](.*?)[‚Äô'"]/);
        if (quoteMatch && quoteMatch[1]) return quoteMatch[1].trim();
      }
      return optionText || "";
    }

    // ---------- Strings ----------
    const STRINGS = {
      ko: {
        appTitle: "ÏÉ§Ïù∏ ÎßÅÌÅ¨",
        pillReady: "Ï§ÄÎπÑ ÏôÑÎ£å",
        pillSaved: "ÌîÑÎ°úÌïÑÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§",
        pillLoaded: "Ïø†ÌÇ§ÏóêÏÑú Î∂àÎü¨ÏôîÏäµÎãàÎã§",
        pillSetup: "Ïù¥Î¶ÑÍ≥º ÏßàÎ¨∏Ïóê Î®ºÏ†Ä ÎãµÌï¥ Ï£ºÏÑ∏Ïöî",

        langButton: "ÌïúÍµ≠Ïñ¥",
        themeAuto: "ÏûêÎèô",
        themeDark: "Îã§ÌÅ¨",
        themeLight: "ÎùºÏù¥Ìä∏",

        intro: "Ïò§Îäò ÌååÌã∞ÏóêÏÑú ÎÇòÏôÄ ÎπÑÏä∑Ìïú ÏÇ¨ÎûåÏùÑ Ï∞æÏïÑÎ≥ºÍπåÏöî? ÏßàÎ¨∏Ïóê ÎãµÌïòÍ≥† ÎÇòÎßåÏùò QRÏùÑ ÎßåÎì§Ïñ¥ Î≥¥ÏÑ∏Ïöî.",
        fullNameLabel: "Ïù¥Î¶Ñ",
        fullNamePlaceholder: "Ïòà: ÍπÄÏòàÏàò",
        saveProfile: "ÎÇ¥ ÎãµÎ≥Ä Ï†ÄÏû•ÌïòÍ≥† QR Î≥¥Í∏∞",
        editProfile: "ÎÇ¥ ÎãµÎ≥Ä ÏàòÏ†ï",

        metTitle: "ÎßåÎÇú ÏÇ¨Îûå",
        metSubtitle: "ÏßÄÍ∏àÍπåÏßÄ ÎßåÎÇú ÏÇ¨Îûå Î™©Î°ù Î≥¥Í∏∞",
        qrDescription: "QRÏóêÎäî Ïù¥Î¶ÑÍ≥º ÎÑ§ Í∞ÄÏßÄ ÏßàÎ¨∏Ïóê ÎåÄÌïú ÎãµÏù¥ Îã¥Í≤® ÏûàÏñ¥Ïöî.",
        scanButton: "QR Ïä§Ï∫îÌïòÍ∏∞",

        scanStatusIntro: "QRÎ•º Í∞ÄÏö¥Îç∞ ÎÑ§Î™® ÏïàÏóê ÎßûÏ∂îÍ≥†, ÎÑàÎ¨¥ Í∞ÄÍπåÏù¥ ÎßêÍ≥† ÏÇ¥Ïßù Îñ®Ïñ¥Ï†∏ Î≥¥ÏÑ∏Ïöî.",
        scanStatusTrying: "QRÎ•º ÏùΩÎäî Ï§ëÏûÖÎãàÎã§‚Ä¶ ÌôîÎ©¥Í≥º Í±∞Î¶¨Î•º Ï°∞Í∏àÎßå Ï°∞Ï†àÌï¥ Ï£ºÏÑ∏Ïöî.",
        scanStatusStopped: "Ïä§Ï∫êÎÑàÍ∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§.",
        scanStatusFormatUnsupported: "QRÏùÄ Ïù∏ÏãùÌñàÏßÄÎßå Ïù¥ Ïï±ÏóêÏÑú ÏÇ¨Ïö©ÌïòÎäî ÌòïÏãùÏù¥ ÏïÑÎãôÎãàÎã§.",
        scanStatusMissingName: "QRÏùÄ Ïù∏ÏãùÌñàÏßÄÎßå Ïù¥Î¶ÑÏù¥ ÏóÜÏäµÎãàÎã§.",

        flipCamera: "Ïπ¥Î©îÎùº Ï†ÑÌôò",
        doneScan: "ÏôÑÎ£å",

        metListTitle: "ÏßÄÍ∏àÍπåÏßÄ ÎßåÎÇú ÏÇ¨Îûå",
        clearMet: "Ï†ÑÏ≤¥ ÏÇ≠Ï†ú",
        back: "Îí§Î°ú",

        emptyState: "ÏïÑÏßÅ ÏïÑÎ¨¥ÎèÑ ÏóÜÏñ¥Ïöî. ÎàÑÍµ∞Í∞ÄÎ•º ÎßåÎÇòÏÑú QRÎ•º Ïä§Ï∫îÌï¥ Î≥¥ÏÑ∏Ïöî!",
        footer: "Îç∞Ïù¥ÌÑ∞Îäî Ïù¥ Î∏åÎùºÏö∞Ï†Ä ÏïàÏóêÎßå Ï†ÄÏû•Îê©ÎãàÎã§ (Ïø†ÌÇ§ ÏÇ¨Ïö©).",

        detailTitle: "ÏÉÅÏÑ∏ Ï†ïÎ≥¥",
        matchBadge: "ÏôÑÏ†Ñ ÏùºÏπò",
        matchPartial: "Î∂ÄÎ∂Ñ ÏùºÏπò",

        alertEnterRequired: "Ïù¥Î¶ÑÍ≥º Î™®Îì† ÏßàÎ¨∏Ïóê ÎãµÌï¥ Ï£ºÏÑ∏Ïöî.",
        alertClearConfirm: "Ï†ïÎßêÎ°ú ÎßåÎÇú ÏÇ¨Îûå Î™©Î°ùÏùÑ Î™®Îëê ÏÇ≠Ï†úÌï†ÍπåÏöî?",
        alertScanned: name => `Ïä§Ï∫î ÏôÑÎ£å: ${name} Îãò Ï†ïÎ≥¥Î•º Ï†ÄÏû•ÌñàÏäµÎãàÎã§.`,
        alertScannedFriendly: name => `ÎßåÎÇòÏÑú Î∞òÍ∞ÄÏõåÏöî, ${name}Îãò!`,
        alertCameraUnsupported: "Ïù¥ Î∏åÎùºÏö∞Ï†ÄÏóêÏÑúÎäî Ïπ¥Î©îÎùºÎ•º ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.",
        alertCameraError: msg => `Ïπ¥Î©îÎùºÏóê Ï†ëÍ∑ºÌï† Ïàò ÏóÜÏäµÎãàÎã§: ${msg}`
      },
      en: {
        appTitle: "Shine Link",
        pillReady: "Ready",
        pillSaved: "Profile saved",
        pillLoaded: "Loaded from cookie",
        pillSetup: "Please enter your name and answer the questions first.",

        langButton: "English",
        themeAuto: "Auto",
        themeDark: "Dark",
        themeLight: "Light",

        intro: "Want to find people like you at the party? Answer a few questions and create your own QR.",
        fullNameLabel: "Name",
        fullNamePlaceholder: "e.g. Minseo Kwon",
        saveProfile: "Save my answers & show QR",
        editProfile: "Edit my answers",

        metTitle: "People I‚Äôve met",
        metSubtitle: "See everyone you‚Äôve met so far",
        qrDescription: "Your QR includes your name and answers to four questions.",
        scanButton: "Scan QR",

        scanStatusIntro: "Align the QR inside the square, not too close, and hold still‚Ä¶",
        scanStatusTrying: "Trying to read the QR‚Ä¶ adjust distance slightly and hold still.",
        scanStatusStopped: "Scanner stopped.",
        scanStatusFormatUnsupported: "QR detected, but format is not supported.",
        scanStatusMissingName: "QR detected, but name is missing.",

        flipCamera: "Flip camera",
        doneScan: "Done",

        metListTitle: "People you‚Äôve met",
        clearMet: "Clear list",
        back: "Back",

        emptyState: "No one yet. Go meet someone and scan their QR!",
        footer: "Data stays in this browser only (stored in cookies).",

        detailTitle: "Details",
        matchBadge: "Perfect match",
        matchPartial: "Partial match",

        alertEnterRequired: "Please fill in your name and answer all questions.",
        alertClearConfirm: "Clear everyone in your met list?",
        alertScanned: name => `Scanned and saved: ${name}`,
        alertScannedFriendly: name => `Nice to meet you, ${name}!`,
        alertCameraUnsupported: "Camera access is not supported in this browser.",
        alertCameraError: msg => `Unable to access camera: ${msg}`
      }
    };

    // ---------- Cookies ----------
    function setCookie(name, value, days) {
      const d = new Date();
      d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
      document.cookie = name + "=" + encodeURIComponent(value) +
        ";expires=" + d.toUTCString() + ";path=/";
    }

    function getCookie(name) {
      const cname = name + "=";
      const decoded = decodeURIComponent(document.cookie);
      const parts = decoded.split(";");
      for (let c of parts) {
        c = c.trim();
        if (c.indexOf(cname) === 0) {
          return c.substring(cname.length);
        }
      }
      return "";
    }

    // ---------- State ----------
    const profileCookieKey = "shine_profile_v2";
    const metCookieKey = "shine_met_list_v2";
    const themeCookieKey = "shine_theme";
    const langCookieKey = "shine_lang";

    // profile: { name, a1, a2, a3, a4 }
    let profile = null;
    // metList: { name, a1, a2, a3, a4, timestamp }
    let metList = [];
    let themeMode = "auto";
    let currentLang = "ko";

    let videoStream = null;
    let usingRear = true;
    let scanLoopId = null;
    let lastScannedValue = null;
    let lastDecodeTime = 0;

    // toast state
    let toastTimeoutId = null;

    function t(key, ...args) {
      const s = STRINGS[currentLang][key];
      return typeof s === "function" ? s(...args) : (s ?? "");
    }

    // ---------- Toast helpers ----------
    const toastEl = document.getElementById("toast");
    const toastMsgEl = document.getElementById("toast-message");
    const toastCloseBtn = document.getElementById("toast-close");

    function showToast(message, durationMs = 2600) {
      toastMsgEl.textContent = message;
      toastEl.classList.add("visible");

      if (toastTimeoutId) {
        clearTimeout(toastTimeoutId);
      }
      toastTimeoutId = setTimeout(() => {
        hideToast();
      }, durationMs);
    }

    function hideToast() {
      toastEl.classList.remove("visible");
      if (toastTimeoutId) {
        clearTimeout(toastTimeoutId);
        toastTimeoutId = null;
      }
    }

    toastCloseBtn.addEventListener("click", hideToast);

    // ---------- DOM refs ----------
    const screens = {
      s1: document.getElementById("screen-1"),
      s2: document.getElementById("screen-2"),
      s3: document.getElementById("screen-3"),
      s4: document.getElementById("screen-4"),
      s5: document.getElementById("screen-5"),
    };

    const appTitleEl = document.getElementById("app-title");
    const pillStatus = document.getElementById("pill-status");
    const langToggleBtn = document.getElementById("lang-toggle");
    const themeToggleBtn = document.getElementById("theme-toggle");
    const introText = document.getElementById("intro-text");

    const fullNameLabel = document.getElementById("label-fullname");
    const fullNameInput = document.getElementById("fullName");
    const saveProfileBtn = document.getElementById("save-profile");
    const editProfileBtn = document.getElementById("edit-profile");

    const q1Options = document.getElementById("q1-options");
    const q2Options = document.getElementById("q2-options");
    const q3Options = document.getElementById("q3-options");
    const q4Options = document.getElementById("q4-options");
    const q1Text = document.getElementById("q1-text");
    const q2Text = document.getElementById("q2-text");
    const q3Text = document.getElementById("q3-text");
    const q4Text = document.getElementById("q4-text");

    const profileSummary = document.getElementById("profile-summary");
    const metTitleEl = document.getElementById("met-title");
    const metSubtitleEl = document.getElementById("met-subtitle");
    const qrDescriptionEl = document.getElementById("qr-description");
    const metCount = document.getElementById("met-count");
    const scanListEl = document.getElementById("scan-list");

    const scanStatus = document.getElementById("scan-status");
    const flipCameraBtn = document.getElementById("flip-camera");
    const stopScanBtn = document.getElementById("stop-scan");
    const openScannerBtn = document.getElementById("open-scanner");

    const metListTitleDom = document.getElementById("met-list-title");
    const clearMetBtn = document.getElementById("clear-met");
    const backToMainBtn = document.getElementById("back-to-main");
    const footerTextEl = document.getElementById("footer-text");

    const detailTitleEl = document.getElementById("detail-title");
    const backFromDetailBtn = document.getElementById("back-from-detail");
    const detailNameEl = document.getElementById("detail-name");
    const detailMetTimeEl = document.getElementById("detail-mettime");
    const detailQaEl = document.getElementById("detail-qa");

    const videoEl = document.getElementById("video");
    const scanCanvas = document.getElementById("scan-canvas");

    function showScreen(name) {
      Object.values(screens).forEach(el => el.classList.remove("active"));
      if (screens[name]) screens[name].classList.add("active");
    }

    function applyTheme() {
      document.body.classList.remove("dark", "light");

      if (themeMode === "auto") {
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        if (prefersDark) {
          document.body.classList.add("dark");
        } else {
          document.body.classList.add("light");
        }
        themeToggleBtn.textContent = t("themeAuto");
      } else if (themeMode === "dark") {
        document.body.classList.add("dark");
        themeToggleBtn.textContent = t("themeDark");
      } else {
        document.body.classList.add("light");
        themeToggleBtn.textContent = t("themeLight");
      }
    }

    function renderQuestions() {
      const qs = getQuestions();

      q1Text.textContent = qs[0].text;
      q2Text.textContent = qs[1].text;
      q3Text.textContent = qs[2].text;
      q4Text.textContent = qs[3].text;

      function renderOptions(container, qId, options) {
        container.innerHTML = "";
        options.forEach((opt, idx) => {
          const label = document.createElement("label");
          label.className = "option-item";

          const input = document.createElement("input");
          input.type = "radio";
          input.name = qId;
          input.value = String(idx);

          const span = document.createElement("span");
          span.textContent = `${idx + 1}. ${opt}`;

          label.appendChild(input);
          label.appendChild(span);
          container.appendChild(label);
        });
      }

      renderOptions(q1Options, "q1", qs[0].options);
      renderOptions(q2Options, "q2", qs[1].options);
      renderOptions(q3Options, "q3", qs[2].options);
      renderOptions(q4Options, "q4", qs[3].options);

      // restore selected values if profile already set
      if (profile) {
        const { a1, a2, a3, a4 } = profile;
        if (a1 != null) {
          const el = document.querySelector(`input[name="q1"][value="${a1}"]`);
          if (el) el.checked = true;
        }
        if (a2 != null) {
          const el = document.querySelector(`input[name="q2"][value="${a2}"]`);
          if (el) el.checked = true;
        }
        if (a3 != null) {
          const el = document.querySelector(`input[name="q3"][value="${a3}"]`);
          if (el) el.checked = true;
        }
        if (a4 != null) {
          const el = document.querySelector(`input[name="q4"][value="${a4}"]`);
          if (el) el.checked = true;
        }
      }
    }

    function applyLanguage() {
      document.documentElement.lang = currentLang === "ko" ? "ko" : "en";
      document.title = t("appTitle");

      appTitleEl.innerHTML = `<span class="logo-dot"></span>${t("appTitle")}`;
      langToggleBtn.textContent = t("langButton");

      introText.textContent = t("intro");
      fullNameLabel.textContent = t("fullNameLabel");
      fullNameInput.placeholder = t("fullNamePlaceholder");

      saveProfileBtn.textContent = t("saveProfile");
      editProfileBtn.textContent = t("editProfile");

      metTitleEl.textContent = t("metTitle");
      metSubtitleEl.textContent = t("metSubtitle");
      qrDescriptionEl.textContent = t("qrDescription");
      openScannerBtn.textContent = t("scanButton");

      flipCameraBtn.textContent = t("flipCamera");
      stopScanBtn.textContent = t("doneScan");
      scanStatus.textContent = t("scanStatusIntro");

      footerTextEl.textContent = t("footer");
      detailTitleEl.textContent = t("detailTitle");

      applyTheme();
      renderQuestions();
      renderMetList(); // updates title with count + subtitle
    }

    function toggleLanguage() {
      currentLang = currentLang === "ko" ? "en" : "ko";
      setCookie(langCookieKey, currentLang, 365);
      applyLanguage();
      updateProfileSummary();
    }

    function toggleTheme() {
      if (themeMode === "auto") themeMode = "dark";
      else if (themeMode === "dark") themeMode = "light";
      else themeMode = "auto";

      setCookie(themeCookieKey, themeMode, 365);
      applyTheme();
    }

    // ---------- QR encoding ----------
    // Format: name|a1|a2|a3|a4  (each answer index 0-2)
    function safeField(str) {
      if (!str) return "";
      return String(str).replace(/\|/g, "¬¶").slice(0, 80);
    }

    function encodeProfileForQR(p) {
      const name = safeField(p.name);
      const a1 = p.a1 ?? 0;
      const a2 = p.a2 ?? 0;
      const a3 = p.a3 ?? 0;
      const a4 = p.a4 ?? 0;
      return `${name}|${a1}|${a2}|${a3}|${a4}`;
    }

    function decodeProfileFromQR(str) {
      const parts = str.split("|");
      if (parts.length < 5) throw new Error("invalid format");
      const name = (parts[0] || "").trim();
      const a1 = parseInt(parts[1] || "0", 10);
      const a2 = parseInt(parts[2] || "0", 10);
      const a3 = parseInt(parts[3] || "0", 10);
      const a4 = parseInt(parts[4] || "0", 10);
      return { name, a1, a2, a3, a4 };
    }

    function updateQR() {
      if (!profile) return;

      const qrContainer = document.getElementById("qrcode");
      if (!qrContainer) return;

      profile = {
        name: profile.name || "",
        a1: profile.a1 ?? 0,
        a2: profile.a2 ?? 0,
        a3: profile.a3 ?? 0,
        a4: profile.a4 ?? 0
      };
      setCookie(profileCookieKey, JSON.stringify(profile), 365);

      const data = encodeProfileForQR(profile);

      qrContainer.innerHTML = "";

      const img = document.createElement("img");
      img.alt = "QR Code";
      img.src = "https://api.qrserver.com/v1/create-qr-code/?" +
        "size=360x360&data=" + encodeURIComponent(data) +
        "&ecc=M";

      qrContainer.appendChild(img);
    }

    // ---------- UI helpers ----------
    function updateProfileSummary() {
      profileSummary.innerHTML = "";
      if (!profile) return;

      const qs = getQuestions();

      // Chip 1: Ïù¥Î¶Ñ
      const chipName = document.createElement("div");
      chipName.className = "chip";
      const strongName = document.createElement("strong");
      strongName.textContent = profile.name;
      chipName.appendChild(strongName);
      profileSummary.appendChild(chipName);

      // Chip 2: only title from Q4 (e.g. "ÏÉ¨Î°¨ Ï†ÑÎèÑÏÇ¨")
      const idx4 = profile.a4 ?? 0;
      const q4Full = qs[3].options[idx4];
      const shortTitle = getQ4ShortTitle(q4Full, idx4);
      const chipChar = document.createElement("div");
      chipChar.className = "chip";
      const strongChar = document.createElement("strong");
      strongChar.textContent = shortTitle;
      chipChar.appendChild(strongChar);
      profileSummary.appendChild(chipChar);
    }

    function updateMetCount() {
      metCount.textContent = String(metList.length);
    }

    function answersAllSame(a, b) {
      if (!a || !b) return false;
      return a.a1 === b.a1 && a.a2 === b.a2 && a.a3 === b.a3 && a.a4 === b.a4;
    }

    function answersShareAny(a, b) {
      if (!a || !b) return false;
      return (
        a.a1 === b.a1 ||
        a.a2 === b.a2 ||
        a.a3 === b.a3 ||
        a.a4 === b.a4
      );
    }

    function updateMetListTitle() {
      const base = t("metListTitle");
      if (currentLang === "ko") {
        metListTitleDom.textContent = `${base} (${metList.length}Î™Ö)`;
      } else {
        metListTitleDom.textContent = `${base} (${metList.length})`;
      }
    }

    function renderMetList() {
      scanListEl.innerHTML = "";
      updateMetListTitle();

      if (!metList.length) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = t("emptyState");
        scanListEl.appendChild(empty);
        return;
      }

      const qs = getQuestions();

      const sorted = metList
        .map((item, idx) => ({ item, idx }))
        .sort((a, b) => b.item.timestamp - a.item.timestamp);

      sorted.forEach(({ item, idx }) => {
        const row = document.createElement("div");
        row.className = "scan-row";
        row.dataset.index = String(idx);

        const header = document.createElement("div");
        header.className = "scan-row-header";

        const main = document.createElement("div");
        main.className = "scan-row-main";
        main.dataset.action = "detail";

        const nameEl = document.createElement("div");
        nameEl.textContent = item.name || (currentLang === "ko" ? "Ïù¥Î¶Ñ ÏóÜÏùå" : "Unknown");

        const timeEl = document.createElement("div");
        const dt = new Date(item.timestamp);
        timeEl.textContent = dt.toLocaleString();
        timeEl.style.fontSize = "0.75rem";
        timeEl.style.opacity = "0.8";

        main.appendChild(nameEl);
        main.appendChild(timeEl);

        const right = document.createElement("div");
        right.className = "scan-row-right";

        // Match badge
        if (profile) {
          if (answersAllSame(profile, item)) {
            const badge = document.createElement("span");
            badge.className = "match-badge-full";
            badge.textContent = t("matchBadge");
            right.appendChild(badge);
          } else if (answersShareAny(profile, item)) {
            const badge = document.createElement("span");
            badge.className = "match-badge-partial";
            badge.textContent = t("matchPartial");
            right.appendChild(badge);
          }
        }

        // Delete button
        const delBtn = document.createElement("button");
        delBtn.className = "btn btn-outline btn-sm";
        delBtn.textContent = currentLang === "ko" ? "ÏÇ≠Ï†ú" : "Delete";
        delBtn.type = "button";
        delBtn.dataset.action = "delete";
        right.appendChild(delBtn);

        header.appendChild(main);
        header.appendChild(right);

        const meta = document.createElement("div");
        meta.className = "scan-row-meta";

        // Subtitle: only Q4 short title, single line
        const idx4 = item.a4 ?? 0;
        const q4Full = qs[3].options[idx4] || "";
        const shortTitle = getQ4ShortTitle(q4Full, idx4);
        const sub = document.createElement("span");
        sub.className = "scan-row-subtitle";
        sub.textContent = shortTitle;
        meta.appendChild(sub);

        row.appendChild(header);
        row.appendChild(meta);
        scanListEl.appendChild(row);
      });
    }

    function saveProfileFromInputs() {
      const name = fullNameInput.value.trim();
      const a1El = document.querySelector('input[name="q1"]:checked');
      const a2El = document.querySelector('input[name="q2"]:checked');
      const a3El = document.querySelector('input[name="q3"]:checked');
      const a4El = document.querySelector('input[name="q4"]:checked');

      if (!name || !a1El || !a2El || !a3El || !a4El) {
        alert(t("alertEnterRequired"));
        return false;
      }

      profile = {
        name,
        a1: parseInt(a1El.value, 10),
        a2: parseInt(a2El.value, 10),
        a3: parseInt(a3El.value, 10),
        a4: parseInt(a4El.value, 10)
      };
      setCookie(profileCookieKey, JSON.stringify(profile), 365);
      return true;
    }

    function saveMetList() {
      setCookie(metCookieKey, JSON.stringify(metList), 365);
    }

    // ---------- Detail view helper ----------
    function showPersonDetail(person) {
      const qs = getQuestions();
      const my = profile;

      detailNameEl.textContent = person.name || "";
      detailMetTimeEl.textContent = person.timestamp
        ? new Date(person.timestamp).toLocaleString()
        : "";

      detailQaEl.innerHTML = "";

      [
        { q: qs[0], key: "a1", idx: person.a1 },
        { q: qs[1], key: "a2", idx: person.a2 },
        { q: qs[2], key: "a3", idx: person.a3 },
        { q: qs[3], key: "a4", idx: person.a4 }
      ].forEach(entry => {
        const wrap = document.createElement("div");
        const qDiv = document.createElement("div");
        qDiv.className = "detail-question";
        qDiv.textContent = entry.q.text;

        const ansDiv = document.createElement("div");
        ansDiv.className = "detail-answer-pill";
        if (my && my[entry.key] === entry.idx) {
          ansDiv.classList.add("detail-answer-same");
        }
        const text = entry.q.options[entry.idx ?? 0] || "";
        ansDiv.textContent = text;

        wrap.appendChild(qDiv);
        wrap.appendChild(ansDiv);
        detailQaEl.appendChild(wrap);
      });

      showScreen("s5");
    }

    // ---------- Scanner ----------
    async function startScanner() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert(t("alertCameraUnsupported"));
        return;
      }
      try {
        pillStatus.textContent = t("pillReady");
        lastScannedValue = null;
        scanStatus.textContent = t("scanStatusIntro");

        const constraints = {
          video: {
            facingMode: usingRear ? { ideal: "environment" } : "user",
            width: { ideal: 640 },
            height: { ideal: 480 }
          },
          audio: false
        };
        videoStream = await navigator.mediaDevices.getUserMedia(constraints);
        videoEl.srcObject = videoStream;

        await new Promise(resolve => {
          if (videoEl.readyState >= 2) resolve();
          else videoEl.onloadedmetadata = () => resolve();
        });

        await videoEl.play();
        showScreen("s3");
        startScanLoop();
      } catch (err) {
        console.error(err);
        alert(t("alertCameraError", err.message));
        pillStatus.textContent = t("pillReady");
      }
    }

    function stopScannerAndStayOnScreen2() {
      if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
      }
      if (scanLoopId) {
        cancelAnimationFrame(scanLoopId);
        scanLoopId = null;
      }
      videoEl.srcObject = null;
      scanStatus.textContent = t("scanStatusStopped");
      pillStatus.textContent = t("pillReady");
      showScreen("s2");
    }

    function stopScannerWithoutNavigation() {
      if (videoStream) {
        videoStream.getTracks().forEach(t => t.stop());
        videoStream = null;
      }
      if (scanLoopId) {
        cancelAnimationFrame(scanLoopId);
        scanLoopId = null;
      }
      videoEl.srcObject = null;
      pillStatus.textContent = t("pillReady");
    }

    function startScanLoop() {
      const ctx = scanCanvas.getContext("2d");

      const loop = () => {
        if (!videoStream) return;

        const now = performance.now();
        if (now - lastDecodeTime < 250) {
          scanLoopId = requestAnimationFrame(loop);
          return;
        }
        lastDecodeTime = now;

        if (videoEl.readyState === videoEl.HAVE_ENOUGH_DATA) {
          const vw = videoEl.videoWidth;
          const vh = videoEl.videoHeight;
          if (vw && vh) {
            scanCanvas.width = vw;
            scanCanvas.height = vh;
            ctx.drawImage(videoEl, 0, 0, vw, vh);

            const size = Math.floor(Math.min(vw, vh) * 0.7);
            const x = Math.floor((vw - size) / 2);
            const y = Math.floor((vh - size) / 2);
            const imageData = ctx.getImageData(x, y, size, size);

            const code = jsQR(imageData.data, imageData.width, imageData.height, {
              inversionAttempts: "dontInvert"
            });

            if (code && code.data) {
              if (code.data !== lastScannedValue) {
                lastScannedValue = code.data;
                handleScannedData(code.data);
              }
            } else {
              scanStatus.textContent = t("scanStatusTrying");
            }
          }
        }
        scanLoopId = requestAnimationFrame(loop);
      };
      loop();
    }

    function handleScannedData(dataStr) {
      let decoded;
      try {
        decoded = decodeProfileFromQR(dataStr);
      } catch (e) {
        console.error("Failed to decode profile from QR:", e);
        scanStatus.textContent = t("scanStatusFormatUnsupported");
        return;
      }

      const name = (decoded.name || "").trim();
      if (!name) {
        scanStatus.textContent = t("scanStatusMissingName");
        return;
      }

      const a1 = decoded.a1 ?? 0;
      const a2 = decoded.a2 ?? 0;
      const a3 = decoded.a3 ?? 0;
      const a4 = decoded.a4 ?? 0;

      let existing = metList.find(
        m =>
          m.name === name &&
          m.a1 === a1 &&
          m.a2 === a2 &&
          m.a3 === a3 &&
          m.a4 === a4
      );

      if (!existing) {
        existing = {
          name,
          a1,
          a2,
          a3,
          a4,
          timestamp: Date.now()
        };
        metList.push(existing);
        saveMetList();
        updateMetCount();
        renderMetList();
      }

      // Stop scanner and go directly to detail screen
      stopScannerWithoutNavigation();
      showPersonDetail(existing);

      // Friendly in-app toast instead of browser alert
      showToast(t("alertScannedFriendly", name));
    }

    // ---------- Events & init ----------
    function wireEvents() {
      langToggleBtn.addEventListener("click", toggleLanguage);
      themeToggleBtn.addEventListener("click", toggleTheme);

      saveProfileBtn.addEventListener("click", () => {
        if (!saveProfileFromInputs()) return;
        pillStatus.textContent = t("pillSaved");
        updateProfileSummary();
        showScreen("s2");
        updateQR();
      });

      editProfileBtn.addEventListener("click", () => {
        if (profile) {
          fullNameInput.value = profile.name || "";
        }
        showScreen("s1");
      });

      clearMetBtn.addEventListener("click", () => {
        if (!metList.length) return;
        if (!confirm(t("alertClearConfirm"))) return;
        metList = [];
        saveMetList();
        updateMetCount();
        renderMetList();
      });

      document.getElementById("open-met-list").addEventListener("click", () => {
        renderMetList();
        showScreen("s4");
      });

      backToMainBtn.addEventListener("click", () => showScreen("s2"));
      backFromDetailBtn.addEventListener("click", () => showScreen("s4"));

      openScannerBtn.addEventListener("click", startScanner);
      stopScanBtn.addEventListener("click", stopScannerAndStayOnScreen2);
      flipCameraBtn.addEventListener("click", async () => {
        usingRear = !usingRear;
        stopScannerWithoutNavigation();
        await startScanner();
      });

      scanListEl.addEventListener("click", e => {
        const row = e.target.closest(".scan-row");
        if (!row) return;
        const idx = parseInt(row.dataset.index, 10);
        const person = metList[idx];
        if (!person) return;

        const action = e.target.dataset.action || e.target.closest("[data-action]")?.dataset.action;

        if (action === "delete") {
          // Delete this individual record
          metList.splice(idx, 1);
          saveMetList();
          updateMetCount();
          renderMetList();
          return;
        }

        if (action === "detail" || !action) {
          showPersonDetail(person);
        }
      });
    }

    function loadCookies() {
      const storedLang = getCookie(langCookieKey);
      if (storedLang === "ko" || storedLang === "en") currentLang = storedLang;

      const storedTheme = getCookie(themeCookieKey);
      if (storedTheme === "auto" || storedTheme === "dark" || storedTheme === "light") {
        themeMode = storedTheme;
      }

      const storedProfile = getCookie(profileCookieKey);
      if (storedProfile) {
        try {
          const p = JSON.parse(storedProfile);
          if (p && typeof p.name === "string") {
            profile = {
              name: p.name || "",
              a1: p.a1 ?? 0,
              a2: p.a2 ?? 0,
              a3: p.a3 ?? 0,
              a4: p.a4 ?? 0
            };
          }
        } catch {
          profile = null;
        }
      }

      const storedMet = getCookie(metCookieKey);
      if (storedMet) {
        try { metList = JSON.parse(storedMet) || []; } catch { metList = []; }
      }
    }

    function initUI() {
      loadCookies();
      applyLanguage();
      wireEvents();

      if (profile) {
        fullNameInput.value = profile.name || "";

        renderQuestions();
        if (profile.a1 != null) {
          const el = document.querySelector(`input[name="q1"][value="${profile.a1}"]`);
          if (el) el.checked = true;
        }
        if (profile.a2 != null) {
          const el = document.querySelector(`input[name="q2"][value="${profile.a2}"]`);
          if (el) el.checked = true;
        }
        if (profile.a3 != null) {
          const el = document.querySelector(`input[name="q3"][value="${profile.a3}"]`);
          if (el) el.checked = true;
        }
        if (profile.a4 != null) {
          const el = document.querySelector(`input[name="q4"][value="${profile.a4}"]`);
          if (el) el.checked = true;
        }

        updateProfileSummary();
        updateQR();
        showScreen("s2");
        pillStatus.textContent = t("pillLoaded");
      } else {
        showScreen("s1");
        pillStatus.textContent = t("pillSetup");
      }
      updateMetCount();
      renderMetList();
    }

    window.addEventListener("load", initUI);
  </script>
</body>
</html>
